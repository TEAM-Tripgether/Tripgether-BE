# ===================================================================
# ìë™ QA ì´ìŠˆ ìƒì„± ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” GitHub ì´ìŠˆ ëŒ“ê¸€ì—ì„œ @suh-lab ë©˜ì…˜ì„ ê°ì§€í•˜ì—¬
# QA(ì‹œí—˜ìš”ì²­) ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
#
# ì‘ë™ ë°©ì‹:
# 1. ì´ìŠˆ ëŒ“ê¸€ì—ì„œ "@suh-lab create qa" ê°ì§€
# 2. ì›ë³¸ ì´ìŠˆ ì œëª©ì—ì„œ ë¶ˆí•„ìš”í•œ ì´ëª¨ì§€ ë° í‚¤ì›Œë“œ ì œê±°
# 3. "ğŸ” [ì‹œí—˜ìš”ì²­]" ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ QA ì´ìŠˆ ìƒì„±
# 4. ì‹œí—˜ í…œí”Œë¦¿ì´ ì ìš©ëœ ë³¸ë¬¸ ìë™ ìƒì„±
# 5. ì›ë³¸ ì´ìŠˆì— QA ì´ìŠˆ ë§í¬ ëŒ“ê¸€ ì‘ì„±
#
# ì§€ì› ê¸°ëŠ¥:
# - ì´ëª¨ì§€ ìë™ ì œê±° (ğŸš€, ğŸ”¥, âŒ› ë“±)
# - ì´ìŠˆ íƒ€ì… í‚¤ì›Œë“œ ì œê±° ([ë²„ê·¸], [ë””ìì¸], [ê¸°ëŠ¥ìš”ì²­] ë“±)
# - ì¹´í…Œê³ ë¦¬ ë° ë‚´ìš© ìë™ ì¶”ì¶œ
# - QA í…œí”Œë¦¿ ìë™ ì ìš©
# - ë‹´ë‹¹ì ìë™ í• ë‹¹
#
# ì‚¬ìš© ì˜ˆì‹œ:
# ì›ë³¸ ì´ìŠˆ: "ğŸš€ [ê¸°ëŠ¥ê°œë°œ][ë¡œê·¸ì¸] ì†Œì…œ ë¡œê·¸ì¸ ì¶”ê°€"
# QA ì´ìŠˆ: "ğŸ” [ì‹œí—˜ìš”ì²­][ë¡œê·¸ì¸] ì†Œì…œ ë¡œê·¸ì¸ ì¶”ê°€"
#
# íŠ¸ë¦¬ê±° ë°©ë²•:
# ì´ìŠˆ ëŒ“ê¸€ì— "@suh-lab create qa" ì…ë ¥
#
# ===================================================================

name: PROJECT-CREATE-QA-ISSUE

on:
  issue_comment:
    types: [created]

jobs:
  create-qa:
    if: |
      contains(github.event.comment.body, '@suh-lab') && 
      contains(github.event.comment.body, 'create qa')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Create QA Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const originalIssue = context.payload.issue;
            const commenter = context.payload.comment.user.login;
            const issueNumber = originalIssue.number;
            
            // ì›ë³¸ ì œëª©
            let title = originalIssue.title;
            console.log('ğŸ“ ì›ë³¸ ì œëª©:', title);
            
            // 1. ì´ëª¨ì§€ ì œê±°
            title = title.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                        .replace(/[\u{2600}-\u{26FF}]/gu, '')
                        .replace(/[\u{2700}-\u{27BF}]/gu, '');
            
            // 2. íŠ¹ì • í‚¤ì›Œë“œ ì•ë¶€ë¶„ê¹Œì§€ ì œê±°
            const keywordPattern = /^.*?\[(ë²„ê·¸|ë””ìì¸|ê¸°ëŠ¥ìš”ì²­|ê¸°ëŠ¥ì¶”ê°€|ê¸°ëŠ¥ê°œì„ )\]/;
            title = title.replace(keywordPattern, '');
            
            // 3. ê³µë°± ì •ë¦¬
            title = title.replace(/^\s+/, '').trim();
            console.log('âœ¨ ì •ì œëœ ì œëª©:', title);
            
            // 4. QA ì´ìŠˆ ì œëª© ìƒì„±
            const qaTitle = `ğŸ” [ì‹œí—˜ìš”ì²­]${title}`;
            console.log('ğŸ¯ QA ì´ìŠˆ ì œëª©:', qaTitle);
            
            // QA ì´ìŠˆ ë³¸ë¬¸ ìƒì„±
            const qaBody = `ğŸ”— ISSUE ì •ë³´
            ---
            - #${issueNumber}

            ğŸ”— PR ì •ë³´
            ---
            <!-- PR ë²ˆí˜¸ë‚˜ URLì„ ì‘ì„±í•´ì£¼ì„¸ìš” -->

            ğŸ§© ì‹œí—˜ ëŒ€ìƒ
            ---

            ${title.replace(/^\[.*?\]\s*/, '')}ì— ëŒ€í•œ ê¸°ëŠ¥ ì‹œí—˜

            ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
            ---

            1. ê¸°ë³¸ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
            2. ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
            3. UI/UX í™•ì¸
            4. ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸

            âš™ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½
            ---
            - **í”„ë¡œì íŠ¸ Version**: 
            - **OS**: 
            - **ë¸Œë¼ìš°ì €**: 
            - **ê¸°ê¸°**: 

            ğŸ™‹â€â™‚ï¸ ë‹´ë‹¹ì
            ---

            - **ì‹œí—˜ë‹´ë‹¹**: ì´ë¦„
            - **ìš”ì²­ì**: @${originalIssue.user.login}

            ---
            *ğŸ¤– ì´ ì´ìŠˆëŠ” @suh-lab ë´‡ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

            try {
              // QA ì´ìŠˆ ìƒì„±
              const { data: qaIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: qaTitle,
                body: qaBody,
                labels: ['ì‘ì—… ì „'],
                assignees: [commenter]
              });
            
              console.log(`âœ… QA ì´ìŠˆ ìƒì„± ì™„ë£Œ: #${qaIssue.number}`);
            
              // ì›ë³¸ ì´ìŠˆì— ëŒ“ê¸€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âœ… **ì‹œí—˜ ìš”ì²­ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**
            
            ğŸ“‹ **QA Issue:** #${qaIssue.number}
            ğŸ”— **ë§í¬:** ${qaIssue.html_url}
            
            ì‹œí—˜ ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ QA ì´ìŠˆì— ê¸°ë¡í•´ì£¼ì„¸ìš”.`
              });
            
              console.log('ğŸ’¬ ì›ë³¸ ì´ìŠˆì— ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ');
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
              console.log('ğŸ‰ QA ì´ìŠˆ ìƒì„± í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!');
              console.log(`  â€¢ ì›ë³¸ ì´ìŠˆ: #${issueNumber}`);
              console.log(`  â€¢ QA ì´ìŠˆ: #${qaIssue.number}`);
              console.log(`  â€¢ ë‹´ë‹¹ì: @${commenter}`);
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            } catch (error) {
              console.error('âŒ ì—ëŸ¬ ë°œìƒ:', error);
            
              // ì—ëŸ¬ ë°œìƒ ì‹œ ëŒ“ê¸€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âŒ QA ì´ìŠˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n\`\`\`\n${error.message}\n\`\`\``
              });
            }