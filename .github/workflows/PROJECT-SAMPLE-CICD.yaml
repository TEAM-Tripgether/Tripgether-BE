name: PROJECT-SAMPLE-CICD

on:
  push:
    branches: ["deploy"]
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì˜µì…˜ ì¶”ê°€

jobs:
  prepare-build:
    name: í™˜ê²½ ì„¤ì • ë° ì¤€ë¹„
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.current_version.outputs.version }}
      build_number: ${{ steps.current_version.outputs.build_number }}
      current_version: ${{ steps.current_version.outputs.current_version }}
      project_type: ${{ steps.current_version.outputs.project_type }}

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git ì„¤ì • ë° ìµœì‹  ìƒíƒœ ë™ê¸°í™”
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin deploy

      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          if [ -f ".github/scripts/version_manager.sh" ]; then
            chmod +x .github/scripts/version_manager.sh
            echo "âœ… ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
          else
            echo "âš ï¸ .github/scripts/version_manager.sh íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      # ë²”ìš© ë²„ì „ ê´€ë¦¬ - ëª¨ë“  í”„ë¡œì íŠ¸ íƒ€ì… ì§€ì›
      - name: í˜„ì¬ ë²„ì „ ë° í”„ë¡œì íŠ¸ ì •ë³´ í™•ì¸
        id: current_version
        run: |
          # version_manager.sh ì‹¤í–‰í•˜ì—¬ ë²„ì „ ê°€ì ¸ì˜¤ê¸°
          VERSION_INFO=$(./.github/scripts/version_manager.sh get | tail -n 1)
          # í”„ë¡œì íŠ¸ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
          PROJECT_TYPE=$(grep "^project_type:" version.yml | sed 's/project_type: *"\([^"]*\)".*/\1/')
          
          echo "í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"
          echo "ë²„ì „ ì •ë³´: $VERSION_INFO"
          
          # í”„ë¡œì íŠ¸ íƒ€ì…ë³„ ë²„ì „ íŒŒì‹± ë¡œì§
          case "$PROJECT_TYPE" in
            "flutter")
              # Flutter í˜•ì‹ (1.2.3+45 ë˜ëŠ” 1.2.3)
              if grep -q "+" <<< "$VERSION_INFO"; then
                VERSION=$(echo "$VERSION_INFO" | cut -d'+' -f1)
                BUILD_NUMBER=$(echo "$VERSION_INFO" | cut -d'+' -f2)
              else
                VERSION="$VERSION_INFO"
                BUILD_NUMBER="1"  # ê¸°ë³¸ê°’
              fi
              CURRENT_VERSION="${VERSION}+${BUILD_NUMBER}"
              ;;
              
            "spring"|"java")
              # Spring/Java í˜•ì‹ (ë³´í†µ 1.2.3)
              VERSION="$VERSION_INFO"
              BUILD_NUMBER=$(date +%Y%m%d%H%M)  # íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©
              CURRENT_VERSION="$VERSION"
              ;;
              
            "react"|"node"|"react-native"|"basic")
              # ì¼ë°˜ JS/TS í”„ë¡œì íŠ¸ (1.2.3)
              VERSION="$VERSION_INFO"
              BUILD_NUMBER=$(date +%s)  # Unix íƒ€ì„ìŠ¤íƒ¬í”„
              CURRENT_VERSION="$VERSION"
              ;;
              
            *)
              # ê¸°ë³¸ ì²˜ë¦¬
              VERSION="$VERSION_INFO"
              BUILD_NUMBER="1"
              CURRENT_VERSION="$VERSION"
              ;;
          esac
          
          # ê²°ê³¼ ì¶œë ¥
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
          
          echo "âœ… ë²„ì „ ì •ë³´ ì¤€ë¹„ ì™„ë£Œ"
          echo "ğŸ“‹ í˜„ì¬ ë²„ì „: $CURRENT_VERSION (ë²„ì „: $VERSION, ë¹Œë“œë²ˆí˜¸: $BUILD_NUMBER)"
          echo "ğŸ”§ í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"

  # í”ŒëŸ¬í„° í”„ë¡œì íŠ¸ ë¹Œë“œ ì˜ˆì‹œ
  build-flutter:
    name: Flutter ì•± ë¹Œë“œ
    needs: prepare-build
    if: needs.prepare-build.outputs.project_type == 'flutter'
    runs-on: ubuntu-latest
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: Flutter ì„¤ì •
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: flutter pub get
        
      - name: Flutter ì•± ë¹Œë“œ
        run: |
          flutter build apk \
            --release \
            --build-name=${{ needs.prepare-build.outputs.version }} \
            --build-number=${{ needs.prepare-build.outputs.build_number }}
            
      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: flutter-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  # ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ ë¹Œë“œ ì˜ˆì‹œ
  build-spring:
    name: Spring Boot ì•± ë¹Œë“œ
    needs: prepare-build
    if: needs.prepare-build.outputs.project_type == 'spring'
    runs-on: ubuntu-latest
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Gradle ìºì‹œ
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          
      - name: Gradle ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew
        
      - name: Gradle ë¹Œë“œ
        run: |
          ./gradlew clean build -x test \
            -Pversion=${{ needs.prepare-build.outputs.version }}

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: spring-jar
          path: build/libs/*.jar

  # Node.js í”„ë¡œì íŠ¸ ë¹Œë“œ ì˜ˆì‹œ
  build-node:
    name: Node.js ì•± ë¹Œë“œ
    needs: prepare-build
    if: needs.prepare-build.outputs.project_type == 'node' || needs.prepare-build.outputs.project_type == 'react'
    runs-on: ubuntu-latest
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ë²„ì „ ì •ë³´ ì£¼ì…
        run: |
          # package.jsonì— ë²„ì „ ì •ë³´ ì—…ë°ì´íŠ¸
          npx json -I -f package.json -e "this.version='${{ needs.prepare-build.outputs.version }}'"
        
      - name: ë¹Œë“œ
        run: npm run build
        
      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: node-build
          path: build/

  # ìµœì¢… ë°°í¬ ì‘ì—…
  deploy:
    name: ë°°í¬
    needs: [prepare-build, build-flutter, build-spring, build-node]
    if: always() && (needs.build-flutter.result == 'success' || needs.build-spring.result == 'success' || needs.build-node.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
      - name: ë°°í¬ ì¤€ë¹„
        run: echo "ğŸš€ ë²„ì „ ${{ needs.prepare-build.outputs.version }} ë°°í¬ ì¤€ë¹„ ì¤‘..."
      
      # ì—¬ê¸°ì— ë°°í¬ ê´€ë ¨ ë‹¨ê³„ ì¶”ê°€ (AWS, Firebase, App Store ë“±)
      
      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "í”„ë¡œì íŠ¸: $(basename ${{ github.repository }})"
          echo "ë²„ì „: ${{ needs.prepare-build.outputs.version }}"
          echo "ë¹Œë“œë²ˆí˜¸: ${{ needs.prepare-build.outputs.build_number }}"
          echo "íƒ€ì…: ${{ needs.prepare-build.outputs.project_type }}"
