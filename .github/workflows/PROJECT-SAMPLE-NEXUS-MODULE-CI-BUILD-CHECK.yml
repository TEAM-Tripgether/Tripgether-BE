name: ğŸ”§ CI Build Check

on:
# ì„ì‹œ ì£¼ì„ ì²˜ë¦¬
#  pull_request:
#    branches: [ main ]
#    types: [opened, synchronize, reopened]
#  push:
#    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v2
      continue-on-error: true

    - name: Create gradle.properties from secret
      run: |
        echo -e "${{ secrets.GRADLE_PROPERTIES }}" > gradle.properties

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: wrapper

    - name: Clean Build Directory
      run: ./gradlew clean

    - name: Compile Sources
      id: compile
      run: |
        set +e
        ./gradlew compileJava compileTestJava 2>&1 | tee compile_output.txt
        echo "compile_exit_code=$?" >> $GITHUB_OUTPUT
        set -e
      continue-on-error: true

    - name: Run Tests
      id: test
      run: |
        set +e
        ./gradlew test 2>&1 | tee test_output.txt
        echo "test_exit_code=$?" >> $GITHUB_OUTPUT
        set -e
      continue-on-error: true

    - name: Build JAR
      id: build
      run: |
        set +e
        ./gradlew build -x test 2>&1 | tee build_output.txt
        echo "build_exit_code=$?" >> $GITHUB_OUTPUT
        set -e
      continue-on-error: true

    - name: Generate Build Report
      id: report
      if: always()
      run: |
        # ë¹Œë“œ ìƒíƒœ í™•ì¸ (exit code ê¸°ë°˜)
        COMPILE_STATUS="âœ… ì„±ê³µ"
        TEST_STATUS="âœ… ì„±ê³µ"
        BUILD_STATUS="âœ… ì„±ê³µ"
        
        # ì»´íŒŒì¼ ìƒíƒœ í™•ì¸
        COMPILE_EXIT_CODE="${{ steps.compile.outputs.compile_exit_code }}"
        if [ "$COMPILE_EXIT_CODE" != "0" ] && [ "$COMPILE_EXIT_CODE" != "" ]; then
          COMPILE_STATUS="âŒ ì‹¤íŒ¨"
        fi
        
        # í…ŒìŠ¤íŠ¸ ìƒíƒœ í™•ì¸  
        TEST_EXIT_CODE="${{ steps.test.outputs.test_exit_code }}"
        if [ "$TEST_EXIT_CODE" != "0" ] && [ "$TEST_EXIT_CODE" != "" ]; then
          TEST_STATUS="âŒ ì‹¤íŒ¨"
        fi
        
        # ë¹Œë“œ ìƒíƒœ í™•ì¸
        BUILD_EXIT_CODE="${{ steps.build.outputs.build_exit_code }}"
        if [ "$BUILD_EXIT_CODE" != "0" ] && [ "$BUILD_EXIT_CODE" != "" ]; then
          BUILD_STATUS="âŒ ì‹¤íŒ¨"
        fi
        
        # ì „ì²´ ë¹Œë“œ ìƒíƒœ
        OVERALL_STATUS="âœ… ì„±ê³µ"
        if [ "$COMPILE_EXIT_CODE" != "0" ] || [ "$TEST_EXIT_CODE" != "0" ] || [ "$BUILD_EXIT_CODE" != "0" ]; then
          OVERALL_STATUS="âŒ ì‹¤íŒ¨"
        fi
        
        echo "compile_status=$COMPILE_STATUS" >> $GITHUB_OUTPUT
        echo "test_status=$TEST_STATUS" >> $GITHUB_OUTPUT
        echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT

    - name: Extract Error Details
      id: errors
      if: always()
      run: |
        # ì»´íŒŒì¼ ì—ëŸ¬ ì¶”ì¶œ
        if [ -f compile_output.txt ] && [ "${{ steps.compile.outputs.compile_exit_code }}" != "0" ]; then
          echo "compile_errors<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸš¨ ì»´íŒŒì¼ ì—ëŸ¬" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          grep -A 15 -B 15 "error\|Error\|ERROR\|FAILED\|Failed\|failed" compile_output.txt | head -60 >> $GITHUB_OUTPUT || echo "ì—ëŸ¬ ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
        # í…ŒìŠ¤íŠ¸ ì—ëŸ¬ ì¶”ì¶œ
        if [ -f test_output.txt ] && [ "${{ steps.test.outputs.test_exit_code }}" != "0" ]; then
          echo "test_errors<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          grep -A 15 -B 15 "FAILED\|Failed\|failed\|error\|Error\|ERROR" test_output.txt | head -60 >> $GITHUB_OUTPUT || echo "í…ŒìŠ¤íŠ¸ ì—ëŸ¬ ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
        # ë¹Œë“œ ì—ëŸ¬ ì¶”ì¶œ
        if [ -f build_output.txt ] && [ "${{ steps.build.outputs.build_exit_code }}" != "0" ]; then
          echo "build_errors<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸ“¦ ë¹Œë“œ ì—ëŸ¬" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          grep -A 15 -B 15 "FAILED\|Failed\|failed\|error\|Error\|ERROR" build_output.txt | head -60 >> $GITHUB_OUTPUT || echo "ë¹Œë“œ ì—ëŸ¬ ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi

    - name: Comment on PR (Success)
      if: github.event_name == 'pull_request' && steps.report.outputs.overall_status == 'âœ… ì„±ê³µ'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸ”§ CI Build Check')
          );
          
          const successMessage = `## ğŸ”§ CI Build Check ê²°ê³¼
          
          ### âœ… ë¹Œë“œ ì„±ê³µ!
          
          | ë‹¨ê³„ | ìƒíƒœ |
          |------|------|
          | ì»´íŒŒì¼ | ${{ steps.report.outputs.compile_status }} |
          | í…ŒìŠ¤íŠ¸ | ${{ steps.report.outputs.test_status }} |
          | ë¹Œë“œ | ${{ steps.report.outputs.build_status }} |
          
          **ì „ì²´ ìƒíƒœ**: ${{ steps.report.outputs.overall_status }}
          
          ---
          *ğŸ¤– GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë¨ - ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: successMessage
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: successMessage
            });
          }

    - name: Comment on PR (Failure)
      if: github.event_name == 'pull_request' && steps.report.outputs.overall_status == 'âŒ ì‹¤íŒ¨'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸ”§ CI Build Check')
          );
          
          let errorDetails = '';
          
          // ì»´íŒŒì¼ ì—ëŸ¬ ì¶”ê°€
          if ('${{ steps.errors.outputs.compile_errors }}') {
            errorDetails += '${{ steps.errors.outputs.compile_errors }}\n\n';
          }
          
          // í…ŒìŠ¤íŠ¸ ì—ëŸ¬ ì¶”ê°€  
          if ('${{ steps.errors.outputs.test_errors }}') {
            errorDetails += '${{ steps.errors.outputs.test_errors }}\n\n';
          }
          
          // ë¹Œë“œ ì—ëŸ¬ ì¶”ê°€
          if ('${{ steps.errors.outputs.build_errors }}') {
            errorDetails += '${{ steps.errors.outputs.build_errors }}\n\n';
          }
          
          const failureMessage = `## ğŸ”§ CI Build Check ê²°ê³¼
          
          ### âŒ ë¹Œë“œ ì‹¤íŒ¨!
          
          | ë‹¨ê³„ | ìƒíƒœ |
          |------|------|
          | ì»´íŒŒì¼ | ${{ steps.report.outputs.compile_status }} |
          | í…ŒìŠ¤íŠ¸ | ${{ steps.report.outputs.test_status }} |
          | ë¹Œë“œ | ${{ steps.report.outputs.build_status }} |
          
          **ì „ì²´ ìƒíƒœ**: ${{ steps.report.outputs.overall_status }}
          
          ### ğŸ“‹ ì—ëŸ¬ ìƒì„¸ ì •ë³´
          
          ${errorDetails}
          
          ### ğŸ”§ í•´ê²° ë°©ë²•
          - ë¡œì»¬ì—ì„œ \`./gradlew clean build\` ëª…ë ¹ì–´ë¡œ ë¹Œë“œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”
          - ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì°¸ê³ í•˜ì—¬ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”
          - í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•œ ê²½ìš° \`./gradlew test\` ëª…ë ¹ì–´ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ì„¸ìš”
          
          ---
          *ğŸ¤– GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë¨ - ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: failureMessage
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: failureMessage
            });
          }

    - name: Create Check Run
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const conclusion = '${{ steps.report.outputs.overall_status }}' === 'âœ… ì„±ê³µ' ? 'success' : 'failure';
          const summary = `ë¹Œë“œ ê²€ì¦ì´ ${conclusion === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}í–ˆìŠµë‹ˆë‹¤.`;
          
          await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: 'Build Verification',
            head_sha: context.sha,
            status: 'completed',
            conclusion: conclusion,
            output: {
              title: 'ğŸ”§ CI Build Check',
              summary: summary,
              text: `
              ì»´íŒŒì¼: ${{ steps.report.outputs.compile_status }}
              í…ŒìŠ¤íŠ¸: ${{ steps.report.outputs.test_status }}  
              ë¹Œë“œ: ${{ steps.report.outputs.build_status }}
              `
            }
          });

    - name: Fail Job on Build Failure
      if: steps.report.outputs.overall_status == 'âŒ ì‹¤íŒ¨'
      run: |
        echo "âŒ ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        exit 1
