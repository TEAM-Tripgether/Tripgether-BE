# ===================================================================
# Spring Boot ì„¤ì • íŒŒì¼ ìë™ ì—…ë¡œë“œ ì›Œí¬í”Œë¡œìš°
# ===================================================================

name: PROJECT-SPRING-AUTO-FILE-UPLOAD

# ===================================================================
# ğŸ“‹ í•„ìˆ˜ GitHub Secrets ì„¤ì • ê°€ì´ë“œ
# ===================================================================
#
# âš ï¸ ì‚¬ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ë‹¤ìŒ GitHub Secretsë¥¼ ì„¤ì •í•˜ì„¸ìš”!
# (ì €ì¥ì†Œ Settings > Secrets and variables > Actionsì—ì„œ ì„¤ì •)
#
# ğŸ”§ í•„ìˆ˜ Secrets:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Secret ì´ë¦„                 â”‚ ì„¤ëª…                               â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ APPLICATION_PROD_YML        â”‚ Spring Boot ìš´ì˜ ì„¤ì • íŒŒì¼ ë‚´ìš©   â”‚
# â”‚ SERVER_HOST                 â”‚ ë°°í¬ ëŒ€ìƒ ì„œë²„ IP/ë„ë©”ì¸           â”‚
# â”‚ SERVER_USER                 â”‚ ì„œë²„ SSH ì ‘ì† ì‚¬ìš©ìëª…             â”‚
# â”‚ SERVER_PASSWORD             â”‚ ì„œë²„ SSH ì ‘ì† ë¹„ë°€ë²ˆí˜¸             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸš€ ì›Œí¬í”Œë¡œìš° ê¸°ëŠ¥:
# - application-prod.yml íŒŒì¼ì„ ì„œë²„ì— ìë™ ì—…ë¡œë“œ
# - ìµœì‹  íŒŒì¼ + íƒ€ì„ìŠ¤íƒ¬í”„ ë°±ì—…ë³¸ ë™ì‹œ ì €ì¥
# - ë©”íƒ€ë°ì´í„° JSON íŒŒì¼ ìë™ ìƒì„±
#
# ğŸ“ ì‚¬ìš© ë°©ë²•:
# 1. ìœ„ì˜ GitHub Secrets ì„¤ì •
# 2. ì•„ë˜ PROJECT_NAMEì„ ì‹¤ì œ í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½
# 3. ì›Œí¬í”Œë¡œìš° í™œì„±í™”: 'on' ì„¹ì…˜ì˜ ì£¼ì„ í•´ì œ
#
# ===================================================================

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  pull_request_target:
    types: [closed]  # PRì´ ë‹«í˜”ì„ ë•Œ (merge í¬í•¨)
    branches:
      - deploy    # deploy ë¸Œëœì¹˜ë¡œì˜ PR
      - test
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

# ===================================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ===================================================================
env:
  # ğŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • - ì‹¤ì œ í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”
  PROJECT_NAME: "tripgether"  # ê¸°ë³¸ê°’: tripgether (í”„ë¡œì íŠ¸ëª…ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)

jobs:
  # ===================================================================
  # íŒŒì¼ ì—…ë¡œë“œ ì‘ì—…
  # ===================================================================
  upload-files:
    name: ì„¤ì • íŒŒì¼ ì„œë²„ ì—…ë¡œë“œ
    runs-on: ubuntu-latest
    # PRì´ ì‹¤ì œë¡œ mergeëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (ë‹«íˆê¸°ë§Œ í•œ ê²½ìš° ì œì™¸)
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. PR ì‘ì„±ì ë˜ëŠ” ì‹¤í–‰ì í™•ì¸
      - name: PR ì‘ì„±ì ë˜ëŠ” ì‹¤í–‰ì í™•ì¸
        id: get_actor
        run: |
          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ actor ê²°ì •
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            # PR merge ì´ë²¤íŠ¸ - PR ì‘ì„±ì ì‚¬ìš©
            ACTOR="${{ github.event.pull_request.user.login }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "ğŸ” PR ì‘ì„±ì: $ACTOR (PR #$PR_NUMBER)"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # ìˆ˜ë™ ì‹¤í–‰ - ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì ì‚¬ìš©
            ACTOR="${{ github.actor }}"
            PR_NUMBER="manual"
            echo "ğŸ‘¤ ìˆ˜ë™ ì‹¤í–‰ì: $ACTOR"
          else
            # push ì´ë²¤íŠ¸ (fallback, í•˜ìœ„ í˜¸í™˜ì„±)
            ACTOR="${{ github.actor }}"
            PR_NUMBER="push"
            echo "ğŸ“¤ Push ì‹¤í–‰ì: $ACTOR"
          fi

          echo "ACTOR=$ACTOR" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT

      # 3. íƒ€ì„ìŠ¤íƒ¬í”„ í´ë”ëª… ìƒì„±
      - name: íƒ€ì„ìŠ¤íƒ¬í”„ í´ë”ëª… ìƒì„±
        run: |
          # Asia/Seoul ë¡œì»¬íƒ€ì„ ì‚¬ìš©
          export TZ='Asia/Seoul'
          ACTOR="${{ steps.get_actor.outputs.ACTOR }}"
          # YYYY-MM-DD_HH-MM-SS_username í˜•ì‹
          TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')_$ACTOR
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date '+%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          echo "ìƒì„±ëœ íƒ€ì„ìŠ¤íƒ¬í”„: $TIMESTAMP"

      # 4. ì§§ì€ ì»¤ë°‹ í•´ì‹œ ê³„ì‚°
      - name: ì§§ì€ ì»¤ë°‹ í•´ì‹œ ê³„ì‚°
        run: |
          echo "SHORT_COMMIT_HASH=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_ENV
          echo "ì§§ì€ ì»¤ë°‹ í•´ì‹œ: $(echo ${{ github.sha }} | cut -c1-7)"

      # 5. ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ
      - name: ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 2022
          envs: TIMESTAMP,SHORT_COMMIT_HASH,BUILD_DATE
          script: |
            set -e
            
            echo "ğŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì •.."
            export PW=${{ secrets.SERVER_PASSWORD }}
            export PROJECT_NAME="${{ env.PROJECT_NAME }}"
            
            # ìµœì‹  íŒŒì¼ ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±
            echo "ğŸ“ ë©”ì¸ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
            echo $PW | sudo -S mkdir -p /volume1/projects/${PROJECT_NAME}/github_secret/backend
            
            # íƒ€ì„ìŠ¤íƒ¬í”„ ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            echo "ğŸ“ íƒ€ì„ìŠ¤íƒ¬í”„ ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘... ($TIMESTAMP)"
            echo $PW | sudo -S mkdir -p /volume1/projects/${PROJECT_NAME}/github_secret/backend/$TIMESTAMP
            
            # application-prod.yml íŒŒì¼ ì—…ë¡œë“œ (ìµœì‹  + ë°±ì—…)
            echo "ğŸ“¤ application-prod.yml íŒŒì¼ ì—…ë¡œë“œ ì¤‘..."
            cat << 'EOF' | sudo tee /volume1/projects/${PROJECT_NAME}/github_secret/backend/application-prod.yml > /dev/null
            ${{ secrets.APPLICATION_PROD_YML }}
            EOF
            cat << 'EOF' | sudo tee /volume1/projects/${PROJECT_NAME}/github_secret/backend/$TIMESTAMP/application-prod.yml > /dev/null
            ${{ secrets.APPLICATION_PROD_YML }}
            EOF
            echo "âœ… application-prod.yml ì—…ë¡œë“œ ì™„ë£Œ"
            
            # ë©”íƒ€ë°ì´í„° JSON íŒŒì¼ ìƒì„± ë° ì—…ë¡œë“œ
            echo "ğŸ“ ë©”íƒ€ë°ì´í„° JSON íŒŒì¼ ìƒì„± ì¤‘..."
            cat << EOF | sudo tee /volume1/projects/${PROJECT_NAME}/github_secret/backend/$TIMESTAMP/cicd-gitignore-file.json > /dev/null
            {
              "build_info": {
                "timestamp": "$TIMESTAMP",
                "workflow": "ì„¤ì • íŒŒì¼ ê´€ë¦¬",
                "run_id": "${{ github.run_id }}",
                "run_number": "${{ github.run_number }}",
                "job": "upload-files",
                "event": "${{ github.event_name }}",
                "repository": "${{ github.repository }}",
                "owner": "${{ github.repository_owner }}",
                "branch": "${{ github.ref_name }}",
                "commit_hash": "${{ github.sha }}",
                "short_hash": "$SHORT_COMMIT_HASH",
                "commit_url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
                "actor": "${{ steps.get_actor.outputs.ACTOR }}",
                "pr_number": "${{ steps.get_actor.outputs.PR_NUMBER }}",
                "pr_author": "${{ github.event.pull_request.user.login || 'N/A' }}",
                "merged_by": "${{ github.event.pull_request.merged_by.login || 'N/A' }}",
                "triggering_actor": "${{ github.triggering_actor }}",
                "build_date": "$BUILD_DATE",
                "runner_os": "${{ runner.os }}"
              },
              "files": [
                {
                  "file_name": "application-prod.yml",
                  "file_path": "/",
                  "last_updated": "$BUILD_DATE",
                  "source_secret": "APPLICATION_PROD_YML"
                }
              ],
              "github_secrets_used": [
                {
                  "name": "PROJECT_MAIN_PORT",
                  "type": "configuration",
                  "usage": "í¬íŠ¸ ì„¤ì •ìš©",
                  "value": "${{ secrets.PROJECT_MAIN_PORT }}"
                },
                {
                  "name": "PROJECT_TEST_PORT",
                  "type": "configuration",
                  "usage": "í…ŒìŠ¤íŠ¸ í¬íŠ¸ ì„¤ì •ìš©",
                  "value": "${{ secrets.PROJECT_TEST_PORT }}"
                },
                {
                  "name": "SERVER_HOST",
                  "type": "credential",
                  "usage": "SSH ì ‘ì†ìš©",
                  "value": "${{ secrets.SERVER_HOST }}"
                },
                {
                  "name": "SERVER_USER",
                  "type": "credential",
                  "usage": "SSH ì ‘ì†ìš©",
                  "value": "${{ secrets.SERVER_USER }}"
                }
              ]
            }
            EOF
            echo "âœ… ë©”íƒ€ë°ì´í„° JSON íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ"
            
            echo ""
            echo "âœ… ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!"
            echo ""
            echo "ğŸ“‹ ì—…ë¡œë“œ ê²°ê³¼ ìš”ì•½:"
            echo "  ğŸ¯ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "  ğŸ‘¤ PR ì‘ì„±ì: ${{ steps.get_actor.outputs.ACTOR }}"
            echo "  ğŸ”¢ PR ë²ˆí˜¸: #${{ steps.get_actor.outputs.PR_NUMBER }}"
            echo "  ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
            echo "  ğŸ“ ì €ì¥ ê²½ë¡œ: /volume1/projects/${PROJECT_NAME}/github_secret/backend/"
            echo "  ğŸ’¾ ë°±ì—… ê²½ë¡œ: /volume1/projects/${PROJECT_NAME}/github_secret/backend/$TIMESTAMP/"
            echo "  â° ì—…ë¡œë“œ ì‹œê°„: $BUILD_DATE"
            echo "  ğŸ“Š ì‚¬ìš©ëœ Secrets: 6ê°œ (Repository), 1ê°œ (Organization)"

# ===================================================================
# ì‚¬ìš© ì˜ˆì‹œ
# ===================================================================
#
# main ë¸Œëœì¹˜ Push ì‹œ ìë™ ì—…ë¡œë“œ:
#
# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:
#
# í•„ìš”í•œ Secrets: APPLICATION_PROD_YML, SERVER_*
#
# ===================================================================
