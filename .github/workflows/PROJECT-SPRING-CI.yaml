# ===================================================================
# Spring Boot CI (ë¹Œë“œ ì „ìš©) ì›Œí¬í”Œë¡œìš°
# ===================================================================

name: PROJECT-SPRING-CI

# ===================================================================
# ğŸ“‹ í•„ìˆ˜ GitHub Secrets ì„¤ì • ê°€ì´ë“œ
# ===================================================================
#
# âš ï¸ ì‚¬ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ë‹¤ìŒ GitHub Secretsë¥¼ ì„¤ì •í•˜ì„¸ìš”!
# (ì €ì¥ì†Œ Settings > Secrets and variables > Actionsì—ì„œ ì„¤ì •)
#
# ğŸ”§ í•„ìˆ˜ Secrets:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Secret ì´ë¦„                 â”‚ ì„¤ëª…                               â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ APPLICATION_PROD_YML        â”‚ Spring Boot ìš´ì˜ ì„¤ì • íŒŒì¼ ë‚´ìš©   â”‚
# â”‚ FCM_JSON                    â”‚ Firebase FCM ì„œë¹„ìŠ¤ ê³„ì • JSON íŒŒì¼ â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸš€ ì›Œí¬í”Œë¡œìš° ê¸°ëŠ¥:
# - Spring Boot í”„ë¡œì íŠ¸ Gradle ë¹Œë“œ
# - test ë¸Œëœì¹˜ PR ì‹œ ë¹Œë“œ ê²€ì¦
# - main ë¸Œëœì¹˜ PR ë° Push ì‹œ ë¹Œë“œ ê²€ì¦
#
# ğŸ“ ì‚¬ìš© ë°©ë²•:
# 1. ìœ„ì˜ GitHub Secrets ì„¤ì •
# 2. ì•„ë˜ PROJECT_NAMEì„ ì‹¤ì œ í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½
# 3. ì›Œí¬í”Œë¡œìš° í™œì„±í™”: 'on' ì„¹ì…˜ì˜ ì£¼ì„ í•´ì œ
#
# ===================================================================

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
    pull_request:
      branches:
        - test    # test ë¸Œëœì¹˜ë¡œ PR ì‹œ ë¹Œë“œ
        - main    # main ë¸Œëœì¹˜ë¡œ PR ì‹œ ë¹Œë“œ
    push:
      branches:
        - main    # main ë¸Œëœì¹˜ë¡œ Push ì‹œ ë¹Œë“œ
    workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

# ===================================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ===================================================================
env:
  # ğŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • - ì‹¤ì œ í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”
  PROJECT_NAME: "tripgether"  # ê¸°ë³¸ê°’: basic (í”„ë¡œì íŠ¸ëª…ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)

  # â˜ï¸ Spring Boot ì„¤ì •
  SPRING_PROFILE: "prod"
  JAVA_VERSION: "21"
  GRADLE_OPTS: "-Dspring.profiles.active=prod"

jobs:
  # ===================================================================
  # ë¹Œë“œ ì‘ì—…
  # ===================================================================
  build:
    name: Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. Java ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: Java ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Gradle Wrapper ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      # 4. Spring Boot ìš´ì˜ í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±
      # GitHub Secretsì—ì„œ APPLICATION_PROD_YML ê°’ì„ ì½ì–´ì™€ì„œ
      # TG-Web/src/main/resources/application-prod.yml íŒŒì¼ë¡œ ìƒì„±
      - name: application-prod.yml ìƒì„±
        run: |
          # TG-Web ëª¨ë“ˆì˜ ë¦¬ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p TG-Web/src/main/resources

          # GitHub Secretsì˜ APPLICATION_PROD_YML ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
          cat << 'EOF' > ./TG-Web/src/main/resources/application-prod.yml
          ${{ secrets.APPLICATION_PROD_YML }}
          EOF

          echo "âœ… application-prod.yml íŒŒì¼ ìƒì„± ì™„ë£Œ (TG-Web/src/main/resources/)"

      # 4-1. Firebase FCM Service Account JSON ìƒì„±
      - name: tripgether-fcm.json ìƒì„±
        run: |
          # GitHub Secretsì˜ FCM_JSON ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
          cat << 'EOF' > ./TG-Web/src/main/resources/tripgether-fcm.json
          ${{ secrets.FCM_JSON }}
          EOF

          echo "âœ… tripgether-fcm.json íŒŒì¼ ìƒì„± ì™„ë£Œ (TG-Web/src/main/resources/)"

      # 5. Gradle ë¹Œë“œ ì‹¤í–‰
      # í…ŒìŠ¤íŠ¸ëŠ” ì œì™¸í•˜ê³  ìš´ì˜ í”„ë¡œíŒŒì¼ë¡œ ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build -x test ${{ env.GRADLE_OPTS }}

      # 6. ë¹Œë“œ ê²°ê³¼ í™•ì¸
      - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
        run: |
          echo "âœ… ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ğŸ“‹ ë¹Œë“œ ê²°ê³¼ ìš”ì•½:"
          echo "  ğŸ¯ í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}"
          echo "  ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  ğŸ“ ì´ë²¤íŠ¸: ${{ github.event_name }}"
          echo "  ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}"
          echo "  ğŸ”– ì»¤ë°‹: ${{ github.sha }}"
          echo "  â° ë¹Œë“œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          ls -lh TG-Web/build/libs/ || echo "ë¹Œë“œ íŒŒì¼ í™•ì¸ ì‹¤íŒ¨"

# ===================================================================
# ì‚¬ìš© ì˜ˆì‹œ
# ===================================================================
#
# test ë¸Œëœì¹˜ PR + main ë¸Œëœì¹˜ PR/Push ëª¨ë‘ ë¹Œë“œí•˜ëŠ” ê²½ìš°:
#
# on:
#   pull_request:
#     branches:
#       - test
#       - main
#   push:
#     branches:
#       - main
#   workflow_dispatch:
#
# ===================================================================
