# ===================================================================
# GitHub í…œí”Œë¦¿ ìë™ ì´ˆê¸°í™” ì›Œí¬í”Œë¡œìš° v2.0.0
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” GitHub í…œí”Œë¦¿ì„ í†µí•´ ìƒˆ í”„ë¡œì íŠ¸ê°€ ìƒì„±ë  ë•Œ
# ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ í”„ë¡œì íŠ¸ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
#
# ğŸ”¥ ì•ˆì „ì¥ì¹˜:
# 1. ì´ìŠˆ ê°œìˆ˜ í™•ì¸ (0ê°œ = ìƒˆ ì €ì¥ì†Œ)
# 2. ì €ì¥ì†Œ ìƒì„±ì¼ í™•ì¸ (ìµœê·¼ 1ì‹œê°„ ì´ë‚´)
#
# ìë™í™” ì‘ì—…:
# 1. version.ymlì„ 0.0.0, basic íƒ€ì…ìœ¼ë¡œ ì´ˆê¸°í™”
# 2. CHANGELOG.md, CHANGELOG.json íŒŒì¼ ì‚­ì œ
# 3. README.mdë¥¼ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ì´ˆê¸°í™”
# 4. ì´ìŠˆ í…œí”Œë¦¿ì˜ assigneeë¥¼ í˜„ì¬ ì €ì¥ì†Œ ì†Œìœ ìë¡œ ë³€ê²½
# 5. ì´ˆê¸°í™” ì™„ë£Œ í›„ ì´ ì›Œí¬í”Œë¡œìš° íŒŒì¼ ìì²´ë¥¼ ì‚­ì œ (ì¼íšŒì„±)
#
# ğŸ›¡ï¸ ì•ˆì „ì¥ì¹˜:
# - ë‹¤ì¤‘ ì¡°ê±´ ê²€ì¦ìœ¼ë¡œ ì¤‘ë³µ ì‹¤í–‰ ì™„ì „ ì°¨ë‹¨
# - í…œí”Œë¦¿ì´ ì•„ë‹Œ ê¸°ì¡´ í”„ë¡œì íŠ¸ì—ì„œ ì‹¤í–‰ ë°©ì§€
# - ì´ˆê¸°í™” ì™„ë£Œ í›„ ì›Œí¬í”Œë¡œìš° ìì²´ ì‚­ì œë¡œ ì¬ì‹¤í–‰ ë¶ˆê°€
#
# ===================================================================

name: PROJECT-TEMPLATE-INITIALIZER

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰
  push:
    paths:
      - '.github/scripts/template_initializer.sh'

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: template-initializer
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-initialization-needed:
    name: ì´ˆê¸°í™” í•„ìš”ì„± í™•ì¸
    runs-on: ubuntu-latest
    outputs:
      needs_init: ${{ steps.check.outputs.needs_init }}
      project_name: ${{ steps.check.outputs.project_name }}
      current_version: ${{ steps.check.outputs.current_version }}
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: ì´ˆê¸°í™” í•„ìš”ì„± í™•ì¸ (ì´ìŠˆ ê°œìˆ˜ + ì €ì¥ì†Œ ìƒì„±ì¼)
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log("=== ğŸ” í…œí”Œë¦¿ ì´ˆê¸°í™” í•„ìš”ì„± í™•ì¸ ===");
            
            let needsInit = true;
            let failureReasons = [];
            
            // 1. ì´ìŠˆ ê°œìˆ˜ í™•ì¸ (0ê°œ = ìƒˆ ì €ì¥ì†Œ)
            console.log("1ï¸âƒ£ ì´ìŠˆ ê°œìˆ˜ í™•ì¸ ì¤‘...");
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 1
            });
            
            if (issues.length > 0) {
              console.log(`âŒ ì´ìŠˆê°€ ${issues.length}ê°œ ì¡´ì¬í•©ë‹ˆë‹¤. (ìƒˆ ì €ì¥ì†Œê°€ ì•„ë‹˜)`);
              failureReasons.push(`ì´ìŠˆ ${issues.length}ê°œ ì¡´ì¬`);
              needsInit = false;
            } else {
              console.log("âœ… ì´ìŠˆê°€ 0ê°œì…ë‹ˆë‹¤. (ìƒˆ ì €ì¥ì†Œ í™•ì¸)");
            }
            
            // 2. ì €ì¥ì†Œ ìƒì„±ì¼ í™•ì¸ (ìµœê·¼ 1ì‹œê°„ ì´ë‚´)
            console.log("2ï¸âƒ£ ì €ì¥ì†Œ ìƒì„±ì¼ í™•ì¸ ì¤‘...");
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const createdAt = new Date(repo.created_at);
            const now = new Date();
            const ageHours = (now - createdAt) / (1000 * 60 * 60);
            
            console.log(`ì €ì¥ì†Œ ìƒì„±: ${createdAt.toISOString()}`);
            console.log(`í˜„ì¬ ì‹œê°„: ${now.toISOString()}`);
            console.log(`ì €ì¥ì†Œ ë‚˜ì´: ${ageHours.toFixed(1)}ì‹œê°„`);
            
            if (ageHours > 1) { // 1ì‹œê°„ ì´ìƒ
              console.log("âŒ ì €ì¥ì†Œê°€ 1ì‹œê°„ ì´ìƒ ì˜¤ë˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
              failureReasons.push(`ì €ì¥ì†Œ ë‚˜ì´ ${ageHours.toFixed(1)}ì‹œê°„`);
              needsInit = false;
            } else {
              console.log("âœ… ìµœê·¼ 1ì‹œê°„ ì´ë‚´ì— ìƒì„±ëœ ì €ì¥ì†Œì…ë‹ˆë‹¤.");
            }
            
            // ê²°ê³¼ ì„¤ì •
            const projectName = context.repo.repo;
            const currentVersion = "í…œí”Œë¦¿";
            
            core.setOutput('needs_init', needsInit.toString());
            core.setOutput('project_name', projectName);
            core.setOutput('current_version', currentVersion);
            
            console.log("\n=== ğŸ¯ ìµœì¢… íŒì • ===");
            if (needsInit) {
              console.log("âœ… í…œí”Œë¦¿ ì´ˆê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤!");
              console.log(`í”„ë¡œì íŠ¸ëª…: ${projectName}`);
              console.log(`ì €ì¥ì†Œ ë‚˜ì´: ${ageHours.toFixed(1)}ì‹œê°„`);
            } else {
              console.log("âŒ í…œí”Œë¦¿ ì´ˆê¸°í™”ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
              console.log("ì‹¤íŒ¨ ì´ìœ :", failureReasons.join(', '));
            }

  initialize-template:
    name: í…œí”Œë¦¿ ì´ˆê¸°í™” ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: check-initialization-needed
    if: needs.check-initialization-needed.outputs.needs_init == 'true'
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Git ì‚¬ìš©ì ì„¤ì •
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x .github/scripts/template_initializer.sh

      - name: í…œí”Œë¦¿ ì´ˆê¸°í™” ì‹¤í–‰
        run: |
          echo "=== í…œí”Œë¦¿ ì´ˆê¸°í™” ì‹œì‘ ==="
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ./.github/scripts/template_initializer.sh \
            "${{ needs.check-initialization-needed.outputs.project_name }}" \
            "${{ github.repository_owner }}"
          
          echo "=== ì´ˆê¸°í™” ì™„ë£Œ ==="

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          echo "=== ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤€ë¹„ ==="
          
          # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ì‚­ì œ (ì¼íšŒì„± ì‹¤í–‰)
          if [ -f ".github/workflows/PROJECT-TEMPLATE-INITIALIZER.yaml" ]; then
            rm -f .github/workflows/PROJECT-TEMPLATE-INITIALIZER.yaml
            echo "âœ… í…œí”Œë¦¿ ì´ˆê¸°í™” ì›Œí¬í”Œë¡œìš° íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
          git status --porcelain
          
          # ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
          git add .
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "âŒ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          commit_message="SUH-DEVOPS-TEMPLATE : init : ${{ needs.check-initialization-needed.outputs.project_name }} ê¸°ë³¸ Template ì´ˆê¸°í™” ì™„ë£Œ

          ìë™ìœ¼ë¡œ ìˆ˜í–‰ëœ ì´ˆê¸°í™” ì‘ì—…:
          - version.yml â†’ 0.0.0, basic íƒ€ì…ìœ¼ë¡œ ì´ˆê¸°í™”
          - CHANGELOG.md, CHANGELOG.json â†’ ì‚­ì œ
          - LICENSE, CONTRIBUTING.md â†’ ì‚­ì œ
          - í…ŒìŠ¤íŠ¸ í´ë”ë“¤ (.github/scripts/test, .github/workflows/test) â†’ ì‚­ì œ
          - README.md â†’ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ì´ˆê¸°í™”  
          - ì´ìŠˆ í…œí”Œë¦¿ assignee â†’ ${{ github.repository_owner }}ë¡œ ë³€ê²½
          - í…œí”Œë¦¿ ì´ˆê¸°í™” ì›Œí¬í”Œë¡œìš° ì‚­ì œ (ì¼íšŒì„± ì‹¤í–‰ ì™„ë£Œ)
          
          í”„ë¡œì íŠ¸: ${{ needs.check-initialization-needed.outputs.project_name }}
          ì´ˆê¸°í™” ì‹œê°„: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          # ì»¤ë°‹ ì‹¤í–‰
          git commit -m "$commit_message"
          
          # ì›ê²© ì €ì¥ì†Œ ìµœì‹  ìƒíƒœ í™•ì¸ í›„ í‘¸ì‹œ
          git fetch origin main
          
          # ì¶©ëŒì´ ìˆìœ¼ë©´ ê°•ì œ í‘¸ì‹œ (í…œí”Œë¦¿ ì´ˆê¸°í™”ëŠ” í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë¯€ë¡œ ì•ˆì „)
          if ! git push origin main; then
            echo "âš ï¸ í‘¸ì‹œ ì¶©ëŒ ë°œìƒ, ê°•ì œ í‘¸ì‹œ ì‹¤í–‰..."
            git push --force-with-lease origin main
          fi
          
          echo "âœ… ì´ˆê¸°í™” ì™„ë£Œ ë° ë³€ê²½ì‚¬í•­ í‘¸ì‹œ ì™„ë£Œ"
