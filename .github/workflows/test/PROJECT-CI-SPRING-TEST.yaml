# ===================================================================
# ë²”ìš© í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” PRì´ test ë¸Œëœì¹˜ë¡œ ìƒì„±ë  ë•Œ í”„ë¡œì íŠ¸ íƒ€ì…ì— ë”°ë¼
# ì ì ˆí•œ ë¹Œë“œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ PRì— ëŒ“ê¸€ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
#
# ì§€ì› í”„ë¡œì íŠ¸ íƒ€ì…:
# - spring: Spring Boot í”„ë¡œì íŠ¸ (Gradle)
# - flutter: Flutter í”„ë¡œì íŠ¸
# - react: React ì›¹ í”„ë¡œì íŠ¸ (npm/yarn)
# - react-native: React Native ëª¨ë°”ì¼ í”„ë¡œì íŠ¸ (npm/yarn + Android/iOS)
# - node: Node.js í”„ë¡œì íŠ¸ (npm/yarn)
# - python: Python í”„ë¡œì íŠ¸
#
# ì‚¬ìš© ë°©ë²•:
# 1. version.ymlì—ì„œ project_typeì„ ì„¤ì •í•˜ì„¸ìš”
# 2. í•„ìš”í•œ GitHub Secretsë¥¼ ì„¤ì •í•˜ì„¸ìš”
# 3. í•„ìš”ì‹œ ë¸Œëœì¹˜ ì¡°ê±´ì„ ìˆ˜ì •í•˜ì„¸ìš”
#
# í•„ìˆ˜ GitHub Secrets (í”„ë¡œì íŠ¸ íƒ€ì…ë³„):
# Spring Boot:
# - APPLICATION_PROD_YML: application-prod.yml íŒŒì¼ ë‚´ìš©
# - SA_KEY: (ì„ íƒ) ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ë‚´ìš©
#
# ===================================================================

name: ë²”ìš© í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸

on:
  pull_request:
    branches: ["test"]  # í•„ìš”ì‹œ ë¸Œëœì¹˜ëª… ìˆ˜ì •

# PR ëŒ“ê¸€ì„ ìœ„í•œ ê¶Œí•œ ì¶”ê°€
permissions:
  contents: read
  pull-requests: write

jobs:
  test-project-build:
    name: ë²”ìš© í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        id: checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: í”„ë¡œì íŠ¸ íƒ€ì… ê°ì§€
        id: detect-project
        run: |
          if [ -f "version.yml" ]; then
            PROJECT_TYPE=$(grep "^project_type:" version.yml | sed 's/project_type: *"\([^"]*\)".*/\1/')
            echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
            echo "âœ… ê°ì§€ëœ í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"
          else
            # í´ë°±: íŒŒì¼ ê¸°ë°˜ ê°ì§€
            if [ -f "build.gradle" ]; then
              echo "project_type=spring" >> $GITHUB_OUTPUT
              echo "âœ… ê°ì§€ëœ í”„ë¡œì íŠ¸ íƒ€ì…: spring (build.gradle ê¸°ë°˜)"
            elif [ -f "package.json" ]; then
              echo "project_type=node" >> $GITHUB_OUTPUT
              echo "âœ… ê°ì§€ëœ í”„ë¡œì íŠ¸ íƒ€ì…: node (package.json ê¸°ë°˜)"
            elif [ -f "pubspec.yaml" ]; then
              echo "project_type=flutter" >> $GITHUB_OUTPUT
              echo "âœ… ê°ì§€ëœ í”„ë¡œì íŠ¸ íƒ€ì…: flutter (pubspec.yaml ê¸°ë°˜)"
            else
              echo "project_type=unknown" >> $GITHUB_OUTPUT
              echo "âš ï¸ í”„ë¡œì íŠ¸ íƒ€ì…ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            fi
          fi

      - name: Java ì„¤ì • (Spring Boot í”„ë¡œì íŠ¸)
        if: steps.detect-project.outputs.project_type == 'spring'
        id: setup-java
        uses: actions/setup-java@v4
        with:
          java-version: 17  # í”„ë¡œì íŠ¸ì— ë§ëŠ” Java ë²„ì „ ì„¤ì •
          distribution: temurin
          cache: gradle

      - name: Node.js ì„¤ì • (React/Node í”„ë¡œì íŠ¸)
        if: contains(fromJson('["react", "react-native", "node"]'), steps.detect-project.outputs.project_type)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Flutter ì„¤ì • (Flutter í”„ë¡œì íŠ¸)
        if: steps.detect-project.outputs.project_type == 'flutter'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
        id: setup-gradle
        run: chmod +x gradlew

      - name: í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±
        id: create-config
        run: |
          # ì„¤ì • íŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p src/main/resources
          
          # application-prod.yml íŒŒì¼ ìƒì„±
          echo "${{ secrets.APPLICATION_PROD_YML }}" > ./src/main/resources/application-prod.yml
          echo "application-prod.yml íŒŒì¼ ìƒì„±ë¨ (í¬ê¸°: $(stat -c%s ./src/main/resources/application-prod.yml) ë°”ì´íŠ¸)"
          
          # ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ìƒì„± (ì„ íƒ ì‚¬í•­)
          if [ ! -z "${{ secrets.VERTEX_SA_KEY }}" ]; then
            echo "${{ secrets.VERTEX_SA_KEY }}" | sed 's/\\n/\n/g' > ./src/main/resources/service-account-key.json
            echo "ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ìƒì„±ë¨ (í¬ê¸°: $(stat -c%s ./src/main/resources/service-account-key.json) ë°”ì´íŠ¸)"
          fi
          
          # ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
          echo "ìƒì„±ëœ ì„¤ì • íŒŒì¼ ëª©ë¡:"
          ls -la ./src/main/resources/

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        id: build-project
        run: |
          # ë¹Œë“œ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
          ./gradlew clean build -x test -Dspring.profiles.active=prod > build_output.txt 2>&1 || {
            echo "BUILD_FAILED=true" >> $GITHUB_ENV
            echo "BUILD_OUTPUT<<EOF" >> $GITHUB_ENV
            # ì—ëŸ¬ ë©”ì‹œì§€ ì¤‘ ì¤‘ìš”í•œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
            grep -E "(error|Error|FAILURE|BUILD FAILED)" build_output.txt | head -20 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            # ì»´íŒŒì¼ ì—ëŸ¬ ìƒì„¸ ì •ë³´ ì¶”ì¶œ
            echo "COMPILE_ERRORS<<EOF" >> $GITHUB_ENV
            grep -A 5 -B 5 "error:" build_output.txt | head -30 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            exit 1
          }
          
          echo "ë¹Œë“œ ì„±ê³µ! ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ì¤‘..."

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
        id: check-artifacts
        run: |
          if [ ! -f "build/libs/"*.jar ]; then
            echo "ARTIFACT_CHECK_FAILED=true" >> $GITHUB_ENV
            echo "ARTIFACT_ERROR=JAR íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!" >> $GITHUB_ENV
            exit 1
          fi
          
          # JAR íŒŒì¼ ì •ë³´ ìˆ˜ì§‘
          JAR_FILE=$(ls build/libs/*.jar | head -1)
          JAR_SIZE=$(ls -lh "$JAR_FILE" | awk '{print $5}')
          echo "JAR_FILE_NAME=$(basename "$JAR_FILE")" >> $GITHUB_ENV
          echo "JAR_FILE_SIZE=$JAR_SIZE" >> $GITHUB_ENV
          
          echo "JAR íŒŒì¼ ìƒì„± í™•ì¸: $(basename "$JAR_FILE") (í¬ê¸°: $JAR_SIZE)"

      - name: ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„±
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jarFileName = process.env.JAR_FILE_NAME;
            const jarFileSize = process.env.JAR_FILE_SIZE;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ ë¹Œë“œ ì„±ê³µ**

              ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì„±ê³µ!

              **ë¹Œë“œ ê²°ê³¼:**
              - JAR íŒŒì¼: \`${jarFileName}\`
              - íŒŒì¼ í¬ê¸°: ${jarFileSize}
              - ë¹Œë“œ ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
              
              ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‘`
            })

      - name: ì»´íŒŒì¼ ì—ëŸ¬ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.BUILD_FAILED == 'true' && env.COMPILE_ERRORS != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const compileErrors = process.env.COMPILE_ERRORS;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨ - ì»´íŒŒì¼ ì—ëŸ¬**

              ì†ŒìŠ¤ì½”ë“œ ì»´íŒŒì¼ ì¤‘ ì˜¤ë¥˜ ë°œìƒ

              **ì»´íŒŒì¼ ì—ëŸ¬ ìƒì„¸:**
              \`\`\`
              ${compileErrors}
              \`\`\`

              [ë¹Œë“œ ë¡œê·¸ í™•ì¸í•˜ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })

      - name: ì¼ë°˜ ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.BUILD_FAILED == 'true' && env.COMPILE_ERRORS == ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const buildOutput = process.env.BUILD_OUTPUT;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨**

              ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤

              **ë¹Œë“œ ì—ëŸ¬:**
              \`\`\`
              ${buildOutput}
              \`\`\`
            
              [ë¹Œë“œ ë¡œê·¸ í™•ì¸í•˜ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.ARTIFACT_CHECK_FAILED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifactError = process.env.ARTIFACT_ERROR;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ì‹¤íŒ¨**

              ğŸ“¦ ë¹Œë“œëŠ” ì™„ë£Œë˜ì—ˆì§€ë§Œ ê²°ê³¼ë¬¼ ìƒì„±ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.

              **ì˜¤ë¥˜:**
              ${artifactError}

              **í•´ê²° ë°©ë²•:**
              1. \`build.gradle\`ì˜ JAR ìƒì„± ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”
              2. ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ì˜ ì¶œë ¥ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”
              3. ë©”ì¸ í´ë˜ìŠ¤ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”`
            })

      - name: ê¸°íƒ€ ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.BUILD_FAILED != 'true' && env.ARTIFACT_CHECK_FAILED != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ì‹¤íŒ¨í•œ ë‹¨ê³„ ì°¾ê¸°
            let failedStep = 'ì•Œ ìˆ˜ ì—†ëŠ” ë‹¨ê³„';
            
            if ('${{ steps.checkout.outcome }}' === 'failure') failedStep = 'ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ';
            else if ('${{ steps.setup-java.outcome }}' === 'failure') failedStep = 'Java í™˜ê²½ ì„¤ì •';
            else if ('${{ steps.setup-gradle.outcome }}' === 'failure') failedStep = 'Gradle ê¶Œí•œ ì„¤ì •';
            else if ('${{ steps.create-config.outcome }}' === 'failure') failedStep = 'í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨**

              âš™ï¸ **ì‹¤íŒ¨í•œ ë‹¨ê³„:** ${failedStep}

              **í•´ê²° ë°©ë²•:**
              1. GitHub Actions ë¡œê·¸ë¥¼ ìƒì„¸íˆ í™•ì¸í•˜ì„¸ìš”
              2. í™˜ê²½ ì„¤ì • ë° ì‹œí¬ë¦¿ ê°’ë“¤ì„ í™•ì¸í•˜ì„¸ìš”
              3. ì›Œí¬í”Œë¡œìš° ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”

              [ë¹Œë“œ ë¡œê·¸ í™•ì¸í•˜ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })
