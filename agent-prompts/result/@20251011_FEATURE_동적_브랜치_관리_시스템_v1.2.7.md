# @20251011_FEATURE_동적_브랜치_관리_시스템_v1.2.7

> **작성일**: 2025년 10월 11일  
> **버전**: v1.2.7  
> **이슈**: [#69 프로젝트 고정 default branch 동적으로 설정되게 필요](https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE/issues/69)  
> **작성자**: SUH-DEVOPS-TEMPLATE 팀

---

## 1. 기능 개요

### 1.1 핵심 기능 설명
GitHub Actions 워크플로우에서 하드코딩된 "main" 브랜치를 동적으로 감지 및 설정하는 시스템을 구축하여, 다양한 기본 브랜치(main, master, develop 등)를 사용하는 프로젝트에서도 유연하게 대응할 수 있도록 개선했습니다.

### 1.2 개발 목적
- **문제점**: 기존에는 모든 워크플로우가 "main" 브랜치로 고정되어 있어, "master" 등 다른 기본 브랜치를 사용하는 프로젝트에서는 수동으로 모든 워크플로우를 수정해야 했음
- **목표**: 프로젝트의 기본 브랜치를 자동으로 감지하고, 초기화 시점에 모든 워크플로우를 자동으로 설정하여 범용성 확보
- **결과**: 템플릿 재사용성 극대화 및 초기 설정 시간 단축

### 1.3 주요 개선사항 요약
1. ✅ **동적 브랜치 감지**: GitHub CLI, git 명령어를 활용한 3단계 폴백 메커니즘
2. ✅ **version.yml 확장**: `metadata.default_branch` 필드 추가로 중앙 집중식 브랜치 관리
3. ✅ **워크플로우 자동 수정**: 초기화 시 모든 워크플로우의 트리거 브랜치 자동 변경
4. ✅ **Flutter 버전 관리 개선**: `x.y.z+buildNumber` 형식의 정확한 처리
5. ✅ **Named Parameters 지원**: `template_initializer.sh`의 사용성 개선

---

## 2. 기술 스택 및 키포인트

### 2.1 사용된 주요 기술
- **Bash Shell Script**: 템플릿 초기화 및 버전 관리 로직
- **GitHub Actions**: 워크플로우 자동화 (YAML)
- **YAML Parsing**: `sed`, `awk`, `grep`를 활용한 파일 조작
- **Git**: 브랜치 정보 감지 및 리포지토리 관리

### 2.2 핵심 문법 요소
```bash
# 1. Named Parameters 파싱
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--version)
            VERSION="$2"
            shift 2
            ;;
        -t|--type)
            PROJECT_TYPE="$2"
            shift 2
            ;;
    esac
done

# 2. 동적 브랜치 감지 (폴백 체인)
detect_default_branch() {
    # 방법 1: GitHub CLI
    detected=$(gh repo view --json defaultBranchRef -q .defaultBranchRef.name 2>/dev/null || echo "")
    
    # 방법 2: git symbolic-ref
    detected=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "")
    
    # 방법 3: git remote show
    detected=$(git remote show origin 2>/dev/null | grep 'HEAD branch' | sed 's/.*: //' || echo "")
    
    # 최종 폴백
    echo "main"
}

# 3. YAML 파일 동적 수정 (sed 활용)
sed -i "s/branches: \[\"main\"\]/branches: [\"$branch\"]/" "$file"
```

### 2.3 중요 디자인 패턴
- **Fallback Chain Pattern**: 여러 감지 방법을 순차적으로 시도하여 안정성 확보
- **Central Configuration Pattern**: `version.yml`을 단일 진실 공급원(Single Source of Truth)으로 활용
- **Inline Dynamic Expression**: GitHub Actions에서 `${{ github.event.repository.default_branch || 'main' }}` 사용

### 2.4 라이브러리/프레임워크 활용
- **GitHub CLI (`gh`)**: 리포지토리 메타데이터 조회
- **Git CLI**: 브랜치 정보 추출
- **YAML**: 구조화된 설정 파일 형식

---

## 3. 상세 구현 내용

### 3.1 주요 구현 로직

#### 3.1.1 `template_initializer.sh` - 템플릿 초기화 스크립트

**핵심 개선사항**:
1. **Named Parameters 지원**
   ```bash
   # Before: 위치 기반 파라미터 (복잡하고 에러 발생 가능)
   ./script.sh 1.0.0 spring
   
   # After: Named Parameters (명확하고 유연함)
   ./template_initializer.sh --version 1.0.0 --type spring
   ./template_initializer.sh -v 1.0.0 -t spring
   ```

2. **동적 브랜치 감지** (Line 174-209)
   ```bash
   detect_default_branch() {
       # 3단계 폴백 메커니즘
       # 1. gh CLI 우선 시도 (가장 정확)
       # 2. git symbolic-ref (로컬 설정 기반)
       # 3. git remote show (원격 저장소 조회)
       # 4. 최종 폴백: "main"
   }
   ```

3. **version.yml 생성** (Line 212-266)
   ```yaml
   version: "0.0.0"
   version_code: 1
   project_type: "basic"
   metadata:
     last_updated: "2025-10-11 08:15:27"
     last_updated_by: "Cassiiopeia"
     default_branch: "main"  # 🆕 동적으로 감지된 브랜치
   ```

4. **워크플로우 트리거 자동 수정** (Line 268-310)
   ```bash
   update_workflow_triggers() {
       # main이 아닌 경우에만 수정
       find .github/workflows -type f \( -name "*.yml" -o -name "*.yaml" \) \
           ! -name "PROJECT-TEMPLATE-INITIALIZER.yaml" | while read -r file; do
           
           # 3가지 패턴 모두 처리
           sed -i "s/branches: \[\"main\"\]/branches: [\"$branch\"]/" "$file"
           sed -i "s/branches: \['main'\]/branches: ['$branch']/" "$file"
           sed -i "s/^\\([[:space:]]*-[[:space:]]*\\)main[[:space:]]*$/\\1$branch/" "$file"
       done
   }
   ```

#### 3.1.2 `version_manager.sh` - 버전 관리 스크립트

**핵심 개선사항**:
1. **Flutter 버전 형식 정확한 처리** (Line 341-351)
   ```bash
   "flutter")
       # version.yml: version: "1.0.0" + version_code: 1
       # pubspec.yaml: version: 1.0.0+1 (조합하여 저장)
       local code=$(get_version_code)
       local full_version="$new_version+$code"
       
       log_debug "Flutter 버전 저장: $new_version (version) + $code (code) = $full_version"
       
       sed -i.bak "s/^version:.*/version: $full_version/" "$VERSION_FILE"
   ```

2. **version_code 자동 증가** (Line 139-159)
   ```bash
   increment_version_code() {
       local current_code=$(get_version_code)
       local new_code=$((current_code + 1))
       
       # version.yml 업데이트
       sed -i.bak "s/^version_code:.*/version_code: $new_code/" version.yml
   }
   ```

3. **increment 명령어 개선** (Line 464-494)
   ```bash
   "increment")
       # 1. 동기화 확인
       current_version=$(sync_versions)
       
       # 2. patch 버전 증가 (x.y.z -> x.y.z+1)
       new_version=$(increment_patch_version "$current_version")
       
       # 3. 모든 버전 파일 업데이트
       update_all_versions "$new_version"
       
       # 4. version_code도 함께 증가
       increment_version_code > /dev/null
   ```

#### 3.1.3 GitHub Actions 워크플로우 수정

**모든 워크플로우에 적용된 동적 브랜치 참조**:

```yaml
# PROJECT-VERSION-CONTROL.yaml (Line 57-62)
- name: 저장소 체크아웃
  uses: actions/checkout@v4
  with:
    token: ${{ secrets.GITHUB_TOKEN }}
    fetch-depth: 0
    ref: ${{ github.event.repository.default_branch || 'main' }}

# PROJECT-AUTO-CHANGELOG-CONTROL.yaml (Line 180-184)
- name: Git Push
  run: |
    DEFAULT_BRANCH="${{ github.event.repository.default_branch || 'main' }}"
    git push origin HEAD:$DEFAULT_BRANCH

# PROJECT-README-VERSION-UPDATE.yaml (Line 166-182)
- name: README 변경사항 푸시
  run: |
    DEFAULT_BRANCH="${{ github.event.repository.default_branch || 'main' }}"
    git push origin HEAD:$DEFAULT_BRANCH

# PROJECT-TEMPLATE-INITIALIZER.yaml (Line 203-209)
- name: Git Push
  run: |
    DEFAULT_BRANCH="${{ github.event.repository.default_branch || 'main' }}"
    git push origin $DEFAULT_BRANCH
```

### 3.2 코드 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                    GitHub Repository                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  metadata.default_branch: "main"                          │  │
│  │  (GitHub API를 통해 제공)                                 │  │
│  └─────────────────────────┬─────────────────────────────────┘  │
│                             │ 감지                               │
└─────────────────────────────┼─────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│           template_initializer.sh (초기화 시점)                │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  detect_default_branch()                                  │  │
│  │  ├─ gh CLI                                                │  │
│  │  ├─ git symbolic-ref                                      │  │
│  │  ├─ git remote show                                       │  │
│  │  └─ fallback: "main"                                      │  │
│  └─────────────────────────┬─────────────────────────────────┘  │
│                             │ 저장                               │
│                             ▼                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  create_version_yml()                                     │  │
│  │  └─ metadata.default_branch: "detected_branch"            │  │
│  └─────────────────────────┬─────────────────────────────────┘  │
│                             │ 적용                               │
│                             ▼                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  update_workflow_triggers()                               │  │
│  │  └─ 모든 워크플로우의 branches: ["main"] → ["master"]    │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│           GitHub Actions Workflows (런타임)                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ref: ${{ github.event.repository.default_branch || 'main' }}│
│  │  └─ 동적으로 브랜치 참조 (폴백 포함)                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  DEFAULT_BRANCH="${{ github.event.repository.default_branch │
│  │                      || 'main' }}"                         │  │
│  │  git push origin HEAD:$DEFAULT_BRANCH                     │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│           version_manager.sh (버전 관리)                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  get / increment / set / sync 명령어                     │  │
│  │  └─ version.yml과 프로젝트 파일 동기화                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Flutter 특화 처리                                        │  │
│  │  └─ version: "x.y.z" + version_code: n → "x.y.z+n"       │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 핵심 알고리즘

#### 3.3.1 브랜치 감지 폴백 체인
```
┌─────────────────┐
│  Start          │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  gh CLI 사용    │───┐
│  가능?          │   │ Yes → default_branch 반환
└────────┬────────┘   │
         │ No         │
         ▼            │
┌─────────────────┐   │
│  git symbolic-  │───┤
│  ref 성공?      │   │ Yes → branch 반환
└────────┬────────┘   │
         │ No         │
         ▼            │
┌─────────────────┐   │
│  git remote     │───┤
│  show 성공?     │   │ Yes → branch 반환
└────────┬────────┘   │
         │ No         │
         ▼            │
┌─────────────────┐   │
│  "main" 반환    │◄──┘
│  (최종 폴백)    │
└─────────────────┘
```

#### 3.3.2 버전 동기화 알고리즘
```
┌─────────────────┐
│  sync_versions  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  version.yml 버전 읽기              │
│  프로젝트 파일 버전 읽기            │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  두 버전이 일치?                    │
└────────┬────────────────────┬───────┘
         │ Yes                │ No
         │                    │
         ▼                    ▼
┌─────────────────┐   ┌────────────────────┐
│  현재 버전 반환 │   │  compare_versions  │
└─────────────────┘   │  높은 버전 선택    │
                      └────────┬───────────┘
                               │
                               ▼
                      ┌────────────────────┐
                      │  양쪽 모두 업데이트│
                      │  - version.yml     │
                      │  - 프로젝트 파일   │
                      └────────────────────┘
```

### 3.4 성능 최적화 방안

1. **워크플로우 수정 시 불필요한 처리 스킵**
   ```bash
   # main 브랜치면 변경 불필요
   if [ "$branch" = "main" ]; then
       log_info "브랜치가 main이므로 워크플로우 변경 불필요"
       return
   fi
   ```

2. **파일 검색 최적화**
   ```bash
   # 초기화 워크플로우 제외하여 불필요한 수정 방지
   find .github/workflows -type f \( -name "*.yml" -o -name "*.yaml" \) \
       ! -name "PROJECT-TEMPLATE-INITIALIZER.yaml"
   ```

3. **한 번에 여러 sed 패턴 처리**
   ```bash
   # 한 파일을 여러 번 열지 않고 3가지 패턴 모두 처리
   sed -i "s/pattern1/replacement1/; s/pattern2/replacement2/" "$file"
   ```

---

## 4. 개선 및 보완사항

### 4.1 이전 버전 대비 개선점

| 항목 | 이전 (v1.2.6) | 현재 (v1.2.7) |
|------|---------------|---------------|
| **브랜치 감지** | 수동 설정 필요 | 자동 감지 (3단계 폴백) |
| **워크플로우 수정** | 수동 편집 | 초기화 시 자동 수정 |
| **version.yml** | `version`, `version_code`, `project_type` | `metadata.default_branch` 추가 |
| **파라미터 방식** | 위치 기반 (복잡) | Named Parameters (직관적) |
| **Flutter 버전** | 주석 불정확 | `x.y.z+buildNumber` 정확한 처리 |
| **워크플로우 체크아웃** | `ref: main` (하드코딩) | `ref: ${{ github.event.repository.default_branch \|\| 'main' }}` |

### 4.2 신규 추가 기능

1. ✅ **`detect_default_branch()` 함수**
   - GitHub CLI, git 명령어를 활용한 다단계 감지
   - 각 방법의 실패 시 자동으로 다음 방법 시도

2. ✅ **`update_workflow_triggers()` 함수**
   - 모든 워크플로우의 트리거 브랜치 자동 변경
   - 3가지 YAML 패턴 모두 지원

3. ✅ **Named Parameters 지원**
   - `-v`, `--version`: 초기 버전 설정
   - `-t`, `--type`: 프로젝트 타입 설정
   - `-h`, `--help`: 도움말 표시

4. ✅ **도움말 시스템**
   - `show_help()` 함수로 상세한 사용법 제공
   - 지원하는 모든 프로젝트 타입 안내

### 4.3 버그 수정 내역

1. ✅ **Flutter 버전 형식 오류 수정**
   - **문제**: 기존에는 `pubspec.yaml`에 `version: x.y.z`만 저장
   - **해결**: `version: x.y.z+buildNumber` 형식으로 정확히 저장
   - **관련 코드**: `version_manager.sh` Line 341-351

2. ✅ **하드코딩된 브랜치 제거**
   - **문제**: 모든 워크플로우에서 `ref: main` 하드코딩
   - **해결**: `${{ github.event.repository.default_branch || 'main' }}` 사용
   - **영향 범위**: 4개 워크플로우 파일 수정

3. ✅ **version.yml Flutter 주석 불일치 수정**
   - **문제**: `flutter: pubspec.yaml (version: 1.0.0)`로 표기
   - **해결**: `flutter: pubspec.yaml (version: 1.0.0+1, buildNumber 포함)`로 수정
   - **관련 파일**: `template_initializer.sh` Line 244

### 4.4 성능 개선 사항

1. **초기화 시간 단축**
   - 기존: 수동으로 10개 이상 파일 수정 (약 10-15분)
   - 개선: 스크립트 실행 한 번 (약 5초)

2. **에러 발생률 감소**
   - 기존: 수동 수정 시 누락 가능성 높음
   - 개선: 자동화로 일관성 보장

---

## 5. 사용 가이드

### 5.1 기본 사용법

#### 5.1.1 템플릿 초기화

```bash
# 1. GitHub 템플릿으로 새 리포지토리 생성

# 2. 리포지토리 클론
git clone https://github.com/your-username/your-repo.git
cd your-repo

# 3. 초기화 스크립트 실행
chmod +x .github/scripts/template_initializer.sh
./.github/scripts/template_initializer.sh --version 1.0.0 --type spring

# 4. 변경사항 커밋 및 푸시
git add .
git commit -m "chore: 템플릿 초기화 완료 v1.0.0"
git push origin main  # 또는 master, develop 등
```

#### 5.1.2 버전 관리

```bash
# 현재 버전 확인
./.github/scripts/version_manager.sh get

# 버전 증가 (patch)
./.github/scripts/version_manager.sh increment

# 특정 버전으로 설정
./.github/scripts/version_manager.sh set 2.0.0

# 버전 동기화 (version.yml ↔ 프로젝트 파일)
./.github/scripts/version_manager.sh sync

# version_code만 증가 (Flutter, React Native 등)
./.github/scripts/version_manager.sh increment-code
```

### 5.2 고급 설정 옵션

#### 5.2.1 프로젝트 타입별 초기화

```bash
# Spring Boot 프로젝트
./template_initializer.sh -v 1.0.0 -t spring

# Flutter 앱
./template_initializer.sh -v 1.0.0 -t flutter

# React 웹 앱
./template_initializer.sh -v 2.0.0 -t react

# React Native 모바일 앱
./template_initializer.sh -v 1.0.0 -t react-native

# React Native Expo
./template_initializer.sh -v 1.0.0 -t react-native-expo

# Node.js 프로젝트
./template_initializer.sh -v 1.0.0 -t node

# Python 프로젝트
./template_initializer.sh -v 1.0.0 -t python

# 기본 (프레임워크 없음)
./template_initializer.sh -v 1.0.0 -t basic
```

#### 5.2.2 version.yml 수동 설정

```yaml
# version.yml
version: "1.2.7"
version_code: 13
project_type: "flutter"
metadata:
  last_updated: "2025-10-11 08:15:27"
  last_updated_by: "Cassiiopeia"
  default_branch: "develop"  # 수동으로 변경 가능
```

### 5.3 실제 사용 예시

#### 예시 1: master 브랜치를 사용하는 프로젝트

```bash
# 1. 리포지토리 기본 브랜치를 master로 설정 (GitHub 웹)

# 2. 초기화 스크립트 실행
./template_initializer.sh -v 1.0.0 -t spring

# 출력:
# [STEP] Default branch 자동 감지 중...
# [INFO] gh CLI로 감지: master
# [STEP] version.yml 파일 생성 중...
# [INFO]   브랜치: master
# [STEP] 워크플로우 트리거 브랜치 변경 중: main → master
#   ✓ PROJECT-VERSION-CONTROL.yaml
#   ✓ PROJECT-AUTO-CHANGELOG-CONTROL.yaml
#   ✓ PROJECT-README-VERSION-UPDATE.yaml
```

#### 예시 2: Flutter 프로젝트 버전 관리

```bash
# 1. 초기화
./template_initializer.sh -v 1.0.0 -t flutter

# version.yml 생성됨:
# version: "1.0.0"
# version_code: 1
# project_type: "flutter"

# 2. 버전 증가
./version_manager.sh increment

# version.yml 업데이트:
# version: "1.0.1"
# version_code: 2

# pubspec.yaml 업데이트:
# version: 1.0.1+2

# 3. 버전 확인
./version_manager.sh get
# 출력: 1.0.1
```

#### 예시 3: 워크플로우 자동 실행

```yaml
# .github/workflows/PROJECT-VERSION-CONTROL.yaml
name: 자동 버전 관리

on:
  push:
    branches: ["master"]  # 자동으로 수정됨
    paths-ignore:
      - 'CHANGELOG.md'
      - 'CHANGELOG.json'
      - 'version.yml'

jobs:
  version-bump:
    runs-on: ubuntu-latest
    steps:
      - name: 저장소 체크아웃
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch || 'main' }}
          # master 브랜치로 자동 체크아웃됨
```

### 5.4 주의사항 및 제한사항

⚠️ **주의사항**:
1. **초기화는 한 번만**: `template_initializer.sh`는 프로젝트 생성 직후 한 번만 실행
2. **project_type 변경 금지**: 초기 설정 후 `version.yml`의 `project_type`은 변경하지 마세요
3. **Git 인증 필요**: 브랜치 감지를 위해 리포지토리에 접근 권한 필요
4. **백업 권장**: 초기화 전 중요한 파일은 백업

🚫 **제한사항**:
1. **지원 프로젝트 타입**: spring, flutter, react, react-native, react-native-expo, node, python, basic
2. **버전 형식**: `x.y.z` (Semantic Versioning)만 지원
3. **YAML 형식**: 워크플로우 파일은 표준 YAML 형식이어야 함
4. **Git 필수**: Git이 설치되어 있어야 브랜치 감지 가능

---

## 6. 테스트 가이드

### 6.1 테스트 환경 설정

```bash
# 1. 테스트용 리포지토리 생성
git clone https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE.git test-repo
cd test-repo

# 2. 스크립트 권한 부여
chmod +x .github/scripts/template_initializer.sh
chmod +x .github/scripts/version_manager.sh

# 3. GitHub CLI 설치 (선택)
# macOS
brew install gh
gh auth login

# Linux
sudo apt install gh
gh auth login
```

### 6.2 단위 테스트 방법

#### 6.2.1 브랜치 감지 테스트

```bash
# 테스트 함수 추출
cat > test_branch_detect.sh << 'EOF'
#!/bin/bash
source .github/scripts/template_initializer.sh

# detect_default_branch 함수 호출
detected=$(detect_default_branch)
echo "감지된 브랜치: $detected"

# 검증
if [ -n "$detected" ]; then
    echo "✅ 테스트 통과"
else
    echo "❌ 테스트 실패"
    exit 1
fi
EOF

chmod +x test_branch_detect.sh
./test_branch_detect.sh
```

#### 6.2.2 버전 관리 테스트

```bash
# 1. 초기 버전 설정
./template_initializer.sh -v 1.0.0 -t basic

# 2. 버전 확인
version=$(./version_manager.sh get)
echo "현재 버전: $version"
[ "$version" = "1.0.0" ] && echo "✅ 초기화 테스트 통과"

# 3. 버전 증가
new_version=$(./.github/scripts/version_manager.sh increment)
echo "새 버전: $new_version"
[ "$new_version" = "1.0.1" ] && echo "✅ 증가 테스트 통과"

# 4. version_code 확인
code=$(./.github/scripts/version_manager.sh get-code)
echo "현재 code: $code"
[ "$code" = "2" ] && echo "✅ version_code 테스트 통과"
```

#### 6.2.3 워크플로우 수정 테스트

```bash
# 1. master 브랜치로 변경 테스트
git checkout -b master
git branch -D main

# 2. 초기화 실행
./template_initializer.sh -v 1.0.0 -t basic

# 3. 워크플로우 파일 확인
grep -r 'branches: \["master"\]' .github/workflows/
# 출력 예시:
# PROJECT-VERSION-CONTROL.yaml:    branches: ["master"]

echo "✅ 워크플로우 수정 테스트 통과"
```

### 6.3 통합 테스트 시나리오

#### 시나리오 1: 전체 초기화 프로세스

```bash
#!/bin/bash
set -e

echo "=== 통합 테스트 시작 ==="

# 1. 템플릿 클론
git clone https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE.git test-integration
cd test-integration

# 2. 기본 브랜치를 develop으로 변경
git checkout -b develop
git branch -D main

# 3. 초기화 실행
./github/scripts/template_initializer.sh -v 2.0.0 -t spring

# 4. version.yml 검증
grep 'version: "2.0.0"' version.yml
grep 'project_type: "spring"' version.yml
grep 'default_branch: "develop"' version.yml

# 5. 워크플로우 검증
grep 'branches: \["develop"\]' .github/workflows/PROJECT-VERSION-CONTROL.yaml

# 6. 버전 증가 테스트
./.github/scripts/version_manager.sh increment

# 7. 최종 버전 확인
version=$(./.github/scripts/version_manager.sh get)
[ "$version" = "2.0.1" ] || exit 1

echo "=== 통합 테스트 성공 ✅ ==="
```

#### 시나리오 2: Flutter 프로젝트 전체 흐름

```bash
#!/bin/bash
set -e

echo "=== Flutter 프로젝트 테스트 시작 ==="

# 1. Flutter 프로젝트로 초기화
./template_initializer.sh -v 1.0.0 -t flutter

# 2. pubspec.yaml 생성 (테스트용)
mkdir -p test_flutter
cat > test_flutter/pubspec.yaml << EOF
name: test_app
version: 1.0.0+1
EOF

# 3. VERSION_FILE 변수 설정
cd test_flutter

# 4. 버전 증가
../.github/scripts/version_manager.sh increment

# 5. pubspec.yaml 검증
grep "version: 1.0.1+2" pubspec.yaml

echo "=== Flutter 테스트 성공 ✅ ==="
```

### 6.4 성능 테스트 방법

```bash
#!/bin/bash

echo "=== 성능 테스트 시작 ==="

# 1. 초기화 시간 측정
start=$(date +%s)
./template_initializer.sh -v 1.0.0 -t basic
end=$(date +%s)
duration=$((end - start))

echo "초기화 시간: ${duration}초"
[ $duration -lt 10 ] && echo "✅ 성능 테스트 통과 (< 10초)"

# 2. 버전 증가 시간 측정
start=$(date +%s)
for i in {1..10}; do
    ./.github/scripts/version_manager.sh increment > /dev/null
done
end=$(date +%s)
duration=$((end - start))

echo "10회 증가 시간: ${duration}초"
[ $duration -lt 5 ] && echo "✅ 버전 증가 성능 테스트 통과 (< 5초)"

echo "=== 성능 테스트 완료 ==="
```

---

## 7. API 명세

### 7.1 `template_initializer.sh` API

#### 7.1.1 명령어 형식

```bash
./template_initializer.sh [OPTIONS]
```

#### 7.1.2 옵션

| 옵션 | 단축 | 필수 | 기본값 | 설명 |
|------|------|------|--------|------|
| `--version` | `-v` | ❌ | `0.0.0` | 초기 버전 설정 (x.y.z 형식) |
| `--type` | `-t` | ❌ | `basic` | 프로젝트 타입 |
| `--help` | `-h` | ❌ | - | 도움말 표시 |

#### 7.1.3 지원 프로젝트 타입

- `spring`: Spring Boot 백엔드
- `flutter`: Flutter 모바일 앱
- `react`: React 웹 앱
- `react-native`: React Native 모바일 앱
- `react-native-expo`: React Native Expo 앱
- `node`: Node.js 프로젝트
- `python`: Python 프로젝트
- `basic`: 기본 (프레임워크 없음)

#### 7.1.4 반환값

| 상태 | 설명 |
|------|------|
| `0` | 성공 |
| `1` | 실패 (잘못된 파라미터, 파일 오류 등) |

#### 7.1.5 사용 예시

```bash
# 기본 초기화
./template_initializer.sh

# Spring Boot 프로젝트
./template_initializer.sh --version 1.0.0 --type spring

# 짧은 형식
./template_initializer.sh -v 2.0.0 -t flutter

# 도움말
./template_initializer.sh --help
```

### 7.2 `version_manager.sh` API

#### 7.2.1 명령어 형식

```bash
./version_manager.sh COMMAND [OPTIONS]
```

#### 7.2.2 명령어

| 명령어 | 설명 | 옵션 |
|--------|------|------|
| `get` | 현재 버전 가져오기 (동기화 포함) | - |
| `get-code` | 현재 `version_code` 가져오기 | - |
| `increment` | patch 버전 증가 + `version_code` 증가 | - |
| `increment-code` | `version_code`만 증가 | - |
| `set` | 특정 버전으로 설정 | `VERSION` |
| `sync` | 버전 파일 간 동기화 | - |
| `validate` | 버전 형식 검증 | `[VERSION]` |

#### 7.2.3 반환값

| 명령어 | 성공 (exit 0) | 실패 (exit 1) |
|--------|---------------|---------------|
| `get` | 현재 버전 출력 (예: `1.2.7`) | - |
| `get-code` | 현재 code 출력 (예: `13`) | - |
| `increment` | 새 버전 출력 (예: `1.2.8`) | 버전 형식 오류 |
| `set` | 설정된 버전 출력 | 잘못된 버전 형식 |
| `sync` | 동기화된 버전 출력 | - |
| `validate` | 유효한 버전 출력 | 잘못된 버전 형식 |

#### 7.2.4 사용 예시

```bash
# 현재 버전 확인
./version_manager.sh get
# 출력: 1.2.7

# 버전 증가
./version_manager.sh increment
# 출력: 1.2.8

# 특정 버전 설정
./version_manager.sh set 2.0.0
# 출력: 2.0.0

# version_code 확인
./version_manager.sh get-code
# 출력: 13

# 버전 검증
./version_manager.sh validate 1.2.3
# 출력: 1.2.3 (유효한 경우)

# 동기화
./version_manager.sh sync
# 출력: 1.2.7
```

### 7.3 에러 코드

| 에러 코드 | 설명 | 발생 상황 |
|-----------|------|-----------|
| `1` | 일반 오류 | 파일 읽기 실패, 권한 오류 등 |
| `1` | 잘못된 버전 형식 | `x.y.z` 형식이 아닌 경우 |
| `1` | 지원하지 않는 프로젝트 타입 | VALID_TYPES에 없는 타입 |
| `1` | version.yml 없음 | 필수 파일 누락 |

---

## 8. 실행 조건 및 환경

### 8.1 필수 시스템 요구사항

#### 8.1.1 운영체제
- ✅ Linux (Ubuntu 20.04+, CentOS 7+)
- ✅ macOS (10.15+)
- ✅ Windows (WSL2 필요)

#### 8.1.2 필수 소프트웨어

| 소프트웨어 | 최소 버전 | 권장 버전 | 필수 여부 |
|------------|-----------|-----------|-----------|
| Bash | 4.0+ | 5.0+ | ✅ 필수 |
| Git | 2.20+ | 2.40+ | ✅ 필수 |
| sed | GNU sed 4.0+ | 4.8+ | ✅ 필수 |
| awk | GNU awk 4.0+ | 5.1+ | ✅ 필수 |
| grep | GNU grep 3.0+ | 3.7+ | ✅ 필수 |
| GitHub CLI (gh) | 2.0+ | 2.30+ | ⚠️ 권장 |

### 8.2 환경 변수 설정

#### 8.2.1 GitHub Actions 환경

```yaml
# 자동으로 제공되는 환경 변수
env:
  GITHUB_ACTOR: ${{ github.actor }}           # GitHub 사용자명
  GITHUB_REPOSITORY: ${{ github.repository }} # owner/repo
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # 인증 토큰
```

#### 8.2.2 로컬 환경

```bash
# ~/.bashrc 또는 ~/.zshrc에 추가

# GitHub 사용자명 (선택)
export GITHUB_ACTOR="your-username"

# GitHub 토큰 (gh CLI 사용 시 필요)
export GITHUB_TOKEN="ghp_xxxxxxxxxxxx"

# 디버그 모드 활성화 (선택)
export DEBUG=true
```

### 8.3 의존성 패키지

#### 8.3.1 GitHub Actions 워크플로우

```yaml
# actions/checkout@v4가 필요
- name: 저장소 체크아웃
  uses: actions/checkout@v4
  with:
    token: ${{ secrets.GITHUB_TOKEN }}
    fetch-depth: 0
```

#### 8.3.2 프로젝트별 추가 요구사항

**Spring Boot**:
```bash
# Gradle 또는 Maven 필요
gradle --version  # 또는
mvn --version
```

**Flutter**:
```bash
flutter --version
# Flutter 3.0.0 이상 권장
```

**React/Node**:
```bash
node --version
npm --version
# Node.js 16.0.0 이상 권장
```

### 8.4 특수 조건 및 제약사항

#### 8.4.1 파일 권한

```bash
# 스크립트 실행 권한 필요
chmod +x .github/scripts/template_initializer.sh
chmod +x .github/scripts/version_manager.sh
```

#### 8.4.2 Git 설정

```bash
# Git 사용자 정보 설정 필요 (로컬 실행 시)
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 원격 저장소 연결 필요
git remote -v
# origin https://github.com/username/repo.git (fetch)
# origin https://github.com/username/repo.git (push)
```

#### 8.4.3 GitHub Actions 제약사항

```yaml
# GITHUB_TOKEN 권한 설정 필요
permissions:
  contents: write  # 파일 수정 및 커밋
  pull-requests: write  # PR 생성 (선택)
```

---

## 9. 문제 해결 가이드

### 9.1 일반적인 이슈 해결방법

#### 9.1.1 브랜치 감지 실패

**증상**:
```
[WARNING] 자동 감지 실패, 기본값 사용: main
```

**원인**:
- GitHub CLI가 설치되지 않음
- Git 원격 저장소 연결 안 됨
- 네트워크 문제

**해결방법**:
```bash
# 1. GitHub CLI 설치
brew install gh  # macOS
sudo apt install gh  # Linux

# 2. GitHub CLI 인증
gh auth login

# 3. Git 원격 저장소 확인
git remote -v

# 4. 원격 저장소 연결
git remote add origin https://github.com/username/repo.git

# 5. 원격 브랜치 정보 업데이트
git fetch origin
git remote show origin
```

#### 9.1.2 워크플로우 수정 안 됨

**증상**:
```
[INFO] 브랜치가 main이므로 워크플로우 변경 불필요
```

**원인**:
- 감지된 브랜치가 "main"이라서 수정 스킵됨

**해결방법**:
```bash
# 1. 수동으로 브랜치 지정
# version.yml 직접 수정
metadata:
  default_branch: "master"  # 원하는 브랜치로 변경

# 2. 워크플로우 수동 수정
sed -i 's/branches: \["main"\]/branches: ["master"]/' \
    .github/workflows/*.yaml
```

#### 9.1.3 version.yml 파일 없음

**증상**:
```
[ERROR] version.yml 파일을 찾을 수 없습니다!
```

**원인**:
- 초기화 스크립트를 실행하지 않음
- 파일이 삭제됨

**해결방법**:
```bash
# 1. 초기화 스크립트 실행
./template_initializer.sh -v 1.0.0 -t basic

# 2. 또는 수동으로 생성
cat > version.yml << EOF
version: "1.0.0"
version_code: 1
project_type: "basic"
metadata:
  last_updated: "$(date -u +"%Y-%m-%d %H:%M:%S")"
  last_updated_by: "$(whoami)"
  default_branch: "main"
EOF
```

#### 9.1.4 Flutter 버전 형식 오류

**증상**:
```
# pubspec.yaml에 version: 1.0.0 으로만 저장됨 (buildNumber 누락)
```

**원인**:
- 이전 버전의 `version_manager.sh` 사용

**해결방법**:
```bash
# 1. version_manager.sh 업데이트
git pull origin main

# 2. 수동으로 수정
# version.yml 확인
cat version.yml
# version: "1.0.0"
# version_code: 5

# pubspec.yaml 수정
sed -i 's/^version:.*/version: 1.0.0+5/' pubspec.yaml
```

### 9.2 디버깅 방법

#### 9.2.1 디버그 모드 활성화

```bash
# 방법 1: 환경 변수 설정
export DEBUG=true
./version_manager.sh get

# 출력 예시:
# 🔍 DEBUG: version.yml 파싱 시작
# 🔍 DEBUG: 현재 version_code: 13
# 🔍 DEBUG: 프로젝트 파일 버전: '1.2.7'
# ✅ 현재 버전: 1.2.7

# 방법 2: 스크립트 내부에서 활성화
DEBUG=true ./template_initializer.sh -v 1.0.0 -t spring
```

#### 9.2.2 수동 단계별 실행

```bash
# 1. version.yml만 생성
cat > version.yml << EOF
version: "1.0.0"
version_code: 1
project_type: "basic"
metadata:
  last_updated: "$(date -u +"%Y-%m-%d %H:%M:%S")"
  last_updated_by: "test-user"
  default_branch: "main"
EOF

# 2. 브랜치 감지만 테스트
gh repo view --json defaultBranchRef -q .defaultBranchRef.name

# 3. 워크플로우 수정만 테스트
find .github/workflows -name "*.yaml" | while read file; do
    echo "검사: $file"
    grep 'branches:' "$file"
done

# 4. 버전 동기화만 테스트
./.github/scripts/version_manager.sh sync
```

### 9.3 로깅 및 모니터링

#### 9.3.1 로그 레벨

스크립트는 다음 로그 레벨을 사용합니다:

```bash
log_info()     # ℹ️  일반 정보
log_success()  # ✅ 성공 메시지
log_warning()  # ⚠️  경고
log_error()    # ❌ 에러
log_debug()    # 🔍 디버그 (DEBUG=true일 때만)
log_step()     # 📍 주요 단계
```

#### 9.3.2 로그 파일 생성

```bash
# 모든 출력을 파일로 저장
./template_initializer.sh -v 1.0.0 -t spring > init.log 2>&1

# 에러만 파일로 저장
./version_manager.sh increment 2> error.log

# 실시간 확인하면서 저장
./template_initializer.sh -v 1.0.0 -t spring | tee init.log
```

#### 9.3.3 GitHub Actions 로그 확인

```yaml
# 워크플로우에서 디버그 출력
- name: 버전 증가
  run: |
    echo "::group::버전 증가 상세 로그"
    DEBUG=true ./.github/scripts/version_manager.sh increment
    echo "::endgroup::"
```

### 9.4 트러블슈팅 체크리스트

#### 초기화 관련

- [ ] Git이 설치되어 있는가?
- [ ] Git 사용자 정보가 설정되어 있는가?
- [ ] 원격 저장소가 연결되어 있는가?
- [ ] 스크립트 실행 권한이 있는가?
- [ ] 올바른 버전 형식(x.y.z)을 사용했는가?
- [ ] 지원하는 프로젝트 타입인가?

#### 버전 관리 관련

- [ ] version.yml 파일이 존재하는가?
- [ ] version.yml 형식이 올바른가?
- [ ] 프로젝트 파일(build.gradle, pubspec.yaml 등)이 존재하는가?
- [ ] 파일 쓰기 권한이 있는가?
- [ ] 버전 형식이 x.y.z인가?

#### 워크플로우 관련

- [ ] GITHUB_TOKEN 권한이 충분한가?
- [ ] 워크플로우 파일 형식이 올바른가?
- [ ] 브랜치 트리거가 올바르게 설정되었는가?
- [ ] version.yml의 default_branch가 올바른가?

---

## 10. 참고 자료

### 10.1 관련 문서 링크

#### 공식 문서
- [GitHub Actions 공식 문서](https://docs.github.com/en/actions)
- [GitHub CLI 공식 문서](https://cli.github.com/manual/)
- [Semantic Versioning](https://semver.org/lang/ko/)
- [Bash Shell Scripting](https://www.gnu.org/software/bash/manual/)

#### 프로젝트별 문서
- [Spring Boot Gradle Plugin](https://docs.spring.io/spring-boot/docs/current/gradle-plugin/reference/htmlsingle/)
- [Flutter Versioning](https://docs.flutter.dev/deployment/android#reviewing-the-app-manifest)
- [package.json Version](https://docs.npmjs.com/cli/v9/configuring-npm/package-json#version)
- [React Native Versioning](https://reactnative.dev/docs/publishing-to-app-store)

### 10.2 코드 저장소 정보

#### 원본 리포지토리
- **리포지토리**: [SUH-DEVOPS-TEMPLATE](https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE)
- **이슈**: [#69 프로젝트 고정 default branch 동적으로 설정되게 필요](https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE/issues/69)
- **브랜치**: `main`
- **버전**: `v1.2.7`

#### 주요 파일 위치
```
SUH-DEVOPS-TEMPLATE/
├── .github/
│   ├── scripts/
│   │   ├── template_initializer.sh   # 템플릿 초기화 스크립트
│   │   └── version_manager.sh        # 버전 관리 스크립트
│   └── workflows/
│       ├── PROJECT-VERSION-CONTROL.yaml
│       ├── PROJECT-AUTO-CHANGELOG-CONTROL.yaml
│       ├── PROJECT-README-VERSION-UPDATE.yaml
│       └── PROJECT-TEMPLATE-INITIALIZER.yaml
├── version.yml                        # 버전 설정 파일
├── README.md
└── CHANGELOG.md
```

### 10.3 추가 학습 자료

#### Bash Scripting
- [Advanced Bash-Scripting Guide](https://tldp.org/LDP/abs/html/)
- [Bash Pitfalls](https://mywiki.wooledge.org/BashPitfalls)
- [ShellCheck - Shell script analysis tool](https://www.shellcheck.net/)

#### GitHub Actions
- [GitHub Actions Workflow Syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)
- [GitHub Actions Contexts](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [GitHub Actions Best Practices](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)

#### YAML Parsing
- [sed Tutorial](https://www.gnu.org/software/sed/manual/sed.html)
- [awk Tutorial](https://www.gnu.org/software/gawk/manual/gawk.html)
- [YAML Specification](https://yaml.org/spec/1.2.2/)

#### Git
- [Git Pro Book](https://git-scm.com/book/ko/v2)
- [Git Branching Strategies](https://nvie.com/posts/a-successful-git-branching-model/)
- [GitHub Flow](https://docs.github.com/en/get-started/quickstart/github-flow)

### 10.4 커뮤니티 및 지원

#### 이슈 및 질문
- GitHub Issues: [SUH-DEVOPS-TEMPLATE Issues](https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE/issues)
- Discussions: [SUH-DEVOPS-TEMPLATE Discussions](https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE/discussions)

#### 기여 가이드
- [CONTRIBUTING.md](https://github.com/Cassiiopeia/SUH-DEVOPS-TEMPLATE/blob/main/CONTRIBUTING.md)
- Pull Request 환영!

---

## 부록 A: 변경 이력

### v1.2.7 (2025-10-11)
- ✨ 동적 브랜치 감지 시스템 추가
- ✨ `template_initializer.sh` Named Parameters 지원
- ✨ 워크플로우 트리거 자동 수정 기능
- ✨ `version.yml`에 `metadata.default_branch` 필드 추가
- 🐛 Flutter 버전 형식 오류 수정 (`x.y.z+buildNumber`)
- 🐛 하드코딩된 "main" 브랜치 제거 (워크플로우)
- 📝 주석 및 문서 개선

### v1.2.6 (2025-10-09)
- 이전 버전 (동적 브랜치 기능 없음)

---

## 부록 B: FAQ

### Q1: 초기화 스크립트를 다시 실행하면 어떻게 되나요?
**A**: 기존 `version.yml`, `README.md` 등이 덮어씌워집니다. 중요한 내용이 있다면 백업 후 실행하세요.

### Q2: master 브랜치를 사용하는데 자동으로 감지되나요?
**A**: 네, GitHub CLI나 git 명령어로 자동 감지됩니다. 감지 실패 시 수동으로 `version.yml`의 `metadata.default_branch`를 수정하세요.

### Q3: 여러 브랜치에서 다른 버전을 관리할 수 있나요?
**A**: `version.yml`은 브랜치별로 독립적입니다. 각 브랜치에서 별도로 버전을 관리할 수 있습니다.

### Q4: Flutter 프로젝트에서 version_code만 증가시키려면?
**A**: `./version_manager.sh increment-code` 명령어를 사용하세요.

### Q5: 워크플로우가 실행되지 않아요.
**A**: 
1. 트리거 브랜치가 현재 브랜치와 일치하는지 확인
2. GITHUB_TOKEN 권한 확인
3. 워크플로우 파일 YAML 문법 확인

### Q6: Spring Boot에서 Gradle과 Maven을 동시에 사용할 수 있나요?
**A**: 스크립트는 Gradle 우선으로 감지합니다. 두 개가 모두 있으면 Gradle만 업데이트됩니다.

### Q7: 버전 형식을 `v1.0.0` (v 접두사 포함)으로 할 수 있나요?
**A**: 아니요. 현재는 `x.y.z` 형식만 지원합니다. 태그에는 `v` 접두사를 사용할 수 있습니다.

### Q8: Windows에서 실행 가능한가요?
**A**: WSL2 (Windows Subsystem for Linux)에서 실행 가능합니다. PowerShell이나 CMD에서는 직접 실행할 수 없습니다.

---

**📌 이 문서는 SUH-DEVOPS-TEMPLATE v1.2.7 기준으로 작성되었습니다.**  
**📅 최종 업데이트: 2025년 10월 11일**  
**✍️ 작성자: SUH-DEVOPS-TEMPLATE 팀**

